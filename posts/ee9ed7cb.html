<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="JUC-深度面试题（粉丝投稿）, jack 计算机 写作 ">
    <meta name="description" content="java | 计算机与网络 | 简书作者">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="baidu-site-verification" content="code-romCwmXVzM" />
    <meta name="google-site-verification" content="pBWoGvVEP36FzzS4xIpoMejc5UKi3RKcxd9rWWcjiDg" />
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>JUC-深度面试题（粉丝投稿） | jack</title>

    <link rel="icon" type="image/jpeg" href="https://v1.mykkto.cn/image/blog/my1SN{XEPO)])9$A7K_JK(BNOV.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?aaa6c944b0ed07922901d7fc571a171d";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
<meta name="generator" content="Hexo 5.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="jack" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://v1.mykkto.cn/image/blog/20211641568137986-ckt-抠图.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">jack</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/census">
          
          <i class="fas fa-layer-group" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>统计</span>
        </a>
      </li>
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-paper-plane" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>时轴</span>
        </a>
      </li>
      
      <li>
        <a href="/categories">
          
          <i class="fas fa-bookmark" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>分类</span>
        </a>
      </li>
      
      <li>
        <a href="/tags">
          
          <i class="fas fa-tag" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>标签</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-heartbeat" style="zoom: 0.6;"></i>
      
      <span>清单</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/List/music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>音乐</span>
        </a>
      </li>
      
      <li>
        <a href="/List/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>相册</span>
        </a>
      </li>
      
      <li>
        <a href="/List/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>视频</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-envelope" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tools" class="waves-effect waves-light">
      
      <i class="fas fa-suitcase" style="zoom: 0.6;"></i>
      
      <span>百宝箱</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/Windows" class="waves-effect waves-light">
      
      <i class="fas fa-desktop" style="zoom: 0.6;"></i>
      
      <span>Windows</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-link" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://v1.mykkto.cn/image/blog/20211641568137986-ckt-抠图.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">jack</div>
        <div class="logo-desc">
            
            java | 计算机与网络 | 简书作者
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-archive"></i>
			
			归档
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/census " style="margin-left:75px">
				  
				   <i class="fa fas fa-layer-group" style="position: absolute;left:50px" ></i>
			      
		          <span>统计</span>
                  </a>
                </li>
              
                <li>

                  <a href="/archives " style="margin-left:75px">
				  
				   <i class="fa fas fa-paper-plane" style="position: absolute;left:50px" ></i>
			      
		          <span>时轴</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories " style="margin-left:75px">
				  
				   <i class="fa fas fa-bookmark" style="position: absolute;left:50px" ></i>
			      
		          <span>分类</span>
                  </a>
                </li>
              
                <li>

                  <a href="/tags " style="margin-left:75px">
				  
				   <i class="fa fas fa-tag" style="position: absolute;left:50px" ></i>
			      
		          <span>标签</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-heartbeat"></i>
			
			清单
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/List/music " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>音乐</span>
                  </a>
                </li>
              
                <li>

                  <a href="/List/galleries " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>相册</span>
                  </a>
                </li>
              
                <li>

                  <a href="/List/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>视频</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-envelope"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tools" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-suitcase"></i>
			
			百宝箱
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/Windows" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-desktop"></i>
			
			Windows
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-link"></i>
			
			友链
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/mykkto/" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/mykkto/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://v1.mykkto.cn/image/galleries/动漫风景/07.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">JUC-深度面试题（粉丝投稿）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        background-color: white;
        width: 345px;
        padding-left: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 35px 2px rgba(0, 0, 0, .15), 0 5px 15px rgba(0, 0, 0, .07), 0 2px 5px -5px rgba(0, 0, 0, .1) !important;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }
    
    #toc-content {
        height: calc(100vh - 300px);
        overflow: scroll;

    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
        bottom: 120px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/juc/">
                                <span class="chip bg-color">juc</span>
                            </a>
                        
                            <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/">
                                <span class="chip bg-color">面试题</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%B8%93%E5%88%8A%E7%AF%87/" class="post-category">
                                专刊篇
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-01-04
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-02-26
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    56 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="2022-JUC-复盘"><a href="#2022-JUC-复盘" class="headerlink" title="2022 JUC 复盘"></a>2022 JUC 复盘</h1><h2 id="大纲目录"><a href="#大纲目录" class="headerlink" title="大纲目录"></a>大纲目录</h2><p>[TOC]</p>
<h3 id="ComlpetableFutuer"><a href="#ComlpetableFutuer" class="headerlink" title="ComlpetableFutuer"></a>ComlpetableFutuer</h3><h4 id="回顾Future"><a href="#回顾Future" class="headerlink" title="回顾Future"></a>回顾Future</h4><h5 id="1future-接口就是定义操作一步执行一些方法，如获得异步任务的执行结果。取消任务的执行，判断任务是否取消，判断任务是否执行完毕。"><a href="#1future-接口就是定义操作一步执行一些方法，如获得异步任务的执行结果。取消任务的执行，判断任务是否取消，判断任务是否执行完毕。" class="headerlink" title="1future 接口就是定义操作一步执行一些方法，如获得异步任务的执行结果。取消任务的执行，判断任务是否取消，判断任务是否执行完毕。"></a>1future 接口就是定义操作一步执行一些方法，如获得异步任务的执行结果。取消任务的执行，判断任务是否取消，判断任务是否执行完毕。</h5><h5 id="2-它具体实现是FutureTask-它同时实现了-Runnable-和Future-接口-。通过它构造方法方法可以传入-callable-和runnable-具体实现类。"><a href="#2-它具体实现是FutureTask-它同时实现了-Runnable-和Future-接口-。通过它构造方法方法可以传入-callable-和runnable-具体实现类。" class="headerlink" title="2 它具体实现是FutureTask ,它同时实现了 Runnable 和Future  接口 。通过它构造方法方法可以传入 callable 和runnable 具体实现类。"></a>2 它具体实现是FutureTask ,它同时实现了 Runnable 和Future  接口 。通过它构造方法方法可以传入 callable 和runnable 具体实现类。</h5><h5 id="3-结论就是-通过futuretask-接可以现实性多线程的异步任务。"><a href="#3-结论就是-通过futuretask-接可以现实性多线程的异步任务。" class="headerlink" title="3 结论就是  通过futuretask 接可以现实性多线程的异步任务。"></a>3 结论就是  通过futuretask 接可以现实性多线程的异步任务。</h5><h5 id="4-futuretask-结合线程池提供效率"><a href="#4-futuretask-结合线程池提供效率" class="headerlink" title="4 futuretask 结合线程池提供效率"></a>4 futuretask 结合线程池提供效率</h5><h5 id="5futuretask-缺点：-1如果耗时很久的异步子线程处理完成之后-，再去调用-get方法获取计算任务程序一切都正常，反之就会导致之线程阻塞。2isDone-方法-轮询容易导致cpu空转-耗损导致更多资源占用。"><a href="#5futuretask-缺点：-1如果耗时很久的异步子线程处理完成之后-，再去调用-get方法获取计算任务程序一切都正常，反之就会导致之线程阻塞。2isDone-方法-轮询容易导致cpu空转-耗损导致更多资源占用。" class="headerlink" title="5futuretask 缺点： 1如果耗时很久的异步子线程处理完成之后 ，再去调用 get方法获取计算任务程序一切都正常，反之就会导致之线程阻塞。2isDone 方法 轮询容易导致cpu空转 耗损导致更多资源占用。"></a>5futuretask 缺点： 1如果耗时很久的异步子线程处理完成之后 ，再去调用 get方法获取计算任务程序一切都正常，反之就会导致之线程阻塞。2isDone 方法 轮询容易导致cpu空转 耗损导致更多资源占用。</h5><h5 id="6针对futuretask-的改进不需通过轮询的方式的判断的线程任务是否完成，通过回调通知函数。异步任务的步骤上的依赖（上一个步骤时下个步骤的前提）这就CompletableFutrure出来的伏笔。"><a href="#6针对futuretask-的改进不需通过轮询的方式的判断的线程任务是否完成，通过回调通知函数。异步任务的步骤上的依赖（上一个步骤时下个步骤的前提）这就CompletableFutrure出来的伏笔。" class="headerlink" title="6针对futuretask 的改进不需通过轮询的方式的判断的线程任务是否完成，通过回调通知函数。异步任务的步骤上的依赖（上一个步骤时下个步骤的前提）这就CompletableFutrure出来的伏笔。"></a>6针对futuretask 的改进不需通过轮询的方式的判断的线程任务是否完成，通过回调通知函数。异步任务的步骤上的依赖（上一个步骤时下个步骤的前提）这就CompletableFutrure出来的伏笔。</h5><h5 id="考点-CompletableFutuer-调用-runAsync-supplyAsync-等静态方法传入一个参数时候，它的线程池是什么？"><a href="#考点-CompletableFutuer-调用-runAsync-supplyAsync-等静态方法传入一个参数时候，它的线程池是什么？" class="headerlink" title="==考点   CompletableFutuer 调用 runAsync supplyAsync   等静态方法传入一个参数时候，它的线程池是什么？=="></a>==考点   CompletableFutuer 调用 <code>runAsync</code> <code>supplyAsync</code>   等静态方法传入一个参数时候，它的线程池是什么？==</h5><h6 id="在调用CompletableFutuer-静态方法默认不传入线程池的参数时候，CompletableFutuer-的ForkJoinpool-。"><a href="#在调用CompletableFutuer-静态方法默认不传入线程池的参数时候，CompletableFutuer-的ForkJoinpool-。" class="headerlink" title="在调用CompletableFutuer 静态方法默认不传入线程池的参数时候，CompletableFutuer 的ForkJoinpool 。"></a>在调用CompletableFutuer 静态方法默认不传入线程池的参数时候，CompletableFutuer 的ForkJoinpool 。</h6><h6 id="code"><a href="#code" class="headerlink" title="code"></a>code</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span><span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"come in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> ruset <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ruset<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">==</span><span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//无异常情况</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上部的计算结果时"</span><span class="token operator">+</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异常情况是"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"主要线程忙其他任务去了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
               e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
           pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭线程池</span>
       <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="考点-CompletableFuture-种方法get-和join-两个方法的区别"><a href="#考点-CompletableFuture-种方法get-和join-两个方法的区别" class="headerlink" title="==考点 CompletableFuture  种方法get  和join 两个方法的区别=="></a>==考点 CompletableFuture  种方法get  和join 两个方法的区别==</h5><h6 id="get-方法需要声明抛异常，二join-不需要-getNow是判断线程任务是是否完成，如果完成就返回完成的状态，如果没有就返回getNow的参数的的值，Handle这个方法可以获得正常和异常的参数结果。"><a href="#get-方法需要声明抛异常，二join-不需要-getNow是判断线程任务是是否完成，如果完成就返回完成的状态，如果没有就返回getNow的参数的的值，Handle这个方法可以获得正常和异常的参数结果。" class="headerlink" title="get 方法需要声明抛异常，二join 不需要  getNow是判断线程任务是是否完成，如果完成就返回完成的状态，如果没有就返回getNow的参数的的值，Handle这个方法可以获得正常和异常的参数结果。"></a>get 方法需要声明抛异常，二join 不需要  <code>getNow</code>是判断线程任务是是否完成，如果完成就返回完成的状态，如果没有就返回getNow的参数的的值，Handle这个方法可以获得正常和异常的参数结果。</h6><h5 id="考点-CompletableFuture-是否都一直调用默认的线程池吗，thenApply-和thenApplyAsync这两个方法有啥却别"><a href="#考点-CompletableFuture-是否都一直调用默认的线程池吗，thenApply-和thenApplyAsync这两个方法有啥却别" class="headerlink" title="==考点 CompletableFuture  是否都一直调用默认的线程池吗，thenApply  和thenApplyAsync这两个方法有啥却别=="></a>==考点 CompletableFuture  是否都一直调用默认的线程池吗，thenApply  和thenApplyAsync这两个方法有啥却别==</h5><h6 id="如果有传入自定义的线程池就按照传入线程执行，当调-ThenRun-方法执行第二个任务时候，则第二个任务和第一个任务共用一个线程池，当调用ThenRunAsync-时候执行第二个任务时候，则第一任务使用自定义的线程池，从第二个任务开始使用的就是ForkJoin-线程池。-还有一种情况是-如果mian-线程执行，那么后续都由main线程执行不会切换线程池。系统优化原则减少切换，main-线程执行效率太快"><a href="#如果有传入自定义的线程池就按照传入线程执行，当调-ThenRun-方法执行第二个任务时候，则第二个任务和第一个任务共用一个线程池，当调用ThenRunAsync-时候执行第二个任务时候，则第一任务使用自定义的线程池，从第二个任务开始使用的就是ForkJoin-线程池。-还有一种情况是-如果mian-线程执行，那么后续都由main线程执行不会切换线程池。系统优化原则减少切换，main-线程执行效率太快" class="headerlink" title="如果有传入自定义的线程池就按照传入线程执行，当调    ThenRun 方法执行第二个任务时候，则第二个任务和第一个任务共用一个线程池，当调用ThenRunAsync 时候执行第二个任务时候，则第一任务使用自定义的线程池，从第二个任务开始使用的就是ForkJoin 线程池。==还有一种情况是 如果mian  线程执行，那么后续都由main线程执行不会切换线程池。系统优化原则减少切换，main 线程执行效率太快=="></a>如果有传入自定义的线程池就按照传入线程执行，当调    ThenRun 方法执行第二个任务时候，则第二个任务和第一个任务共用一个线程池，当调用ThenRunAsync 时候执行第二个任务时候，则第一任务使用自定义的线程池，从第二个任务开始使用的就是ForkJoin 线程池。==还有一种情况是 如果mian  线程执行，那么后续都由main线程执行不会切换线程池。系统优化原则减少切换，main 线程执行效率太快==</h6><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompleateFutureAPIDome</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自定义线程池</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当前线程池是pool</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"222"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenApplyAsync</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token comment">//这个之后都是默认线程池</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前线程池是 ForkJoin 线程池</span>
           
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"333"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"打印出来是"</span><span class="token operator">+</span>v <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E4%B8%A4%E7%A7%8D%E7%9A%84%E5%8C%BA%E5%88%AB.png" alt="这两种的区别的图例"></p>
<h3 id="Java-锁的哪些事"><a href="#Java-锁的哪些事" class="headerlink" title="Java 锁的哪些事"></a>Java 锁的哪些事</h3><h4 id="何为悲观锁何为乐观锁"><a href="#何为悲观锁何为乐观锁" class="headerlink" title="==何为悲观锁何为乐观锁=="></a>==何为悲观锁何为乐观锁==</h4><h5 id="悲观锁概念：大白话的，线程执行的任务其他线程一定会和它抢资源，因此在获取数据之前一定是加一把锁，确保数据安全没有背修改过。规则是先加锁。"><a href="#悲观锁概念：大白话的，线程执行的任务其他线程一定会和它抢资源，因此在获取数据之前一定是加一把锁，确保数据安全没有背修改过。规则是先加锁。" class="headerlink" title="悲观锁概念：大白话的，线程执行的任务其他线程一定会和它抢资源，因此在获取数据之前一定是加一把锁，确保数据安全没有背修改过。规则是先加锁。"></a>悲观锁概念：大白话的，线程执行的任务其他线程一定会和它抢资源，因此在获取数据之前一定是加一把锁，确保数据安全没有背修改过。规则是先加锁。</h5><h5 id="乐观锁的概念：线程执行的时候认为不会有其他线程和它抢占资源（其他线程不会修改数据），所以不会加锁。规则不会加锁，但是通过版本好的迭代或者CAS-自旋来判断。（比较并交换的状态）"><a href="#乐观锁的概念：线程执行的时候认为不会有其他线程和它抢占资源（其他线程不会修改数据），所以不会加锁。规则不会加锁，但是通过版本好的迭代或者CAS-自旋来判断。（比较并交换的状态）" class="headerlink" title="乐观锁的概念：线程执行的时候认为不会有其他线程和它抢占资源（其他线程不会修改数据），所以不会加锁。规则不会加锁，但是通过版本好的迭代或者CAS 自旋来判断。（比较并交换的状态）"></a>乐观锁的概念：线程执行的时候认为不会有其他线程和它抢占资源（其他线程不会修改数据），所以不会加锁。规则不会加锁，但是通过版本好的迭代或者CAS 自旋来判断。（比较并交换的状态）</h5><h4 id="根据8-锁用例场景总结"><a href="#根据8-锁用例场景总结" class="headerlink" title="==根据8 锁用例场景总结=="></a>==根据8 锁用例场景总结==</h4><h5 id="当对象同时多个synchronzied-方法，当某一时刻内，只要一个线程去调用其中的一个synchronzied-方法-其他线都要等待它执行完毕再执行。锁是当前对象this-因为对象是jvm-堆里面"><a href="#当对象同时多个synchronzied-方法，当某一时刻内，只要一个线程去调用其中的一个synchronzied-方法-其他线都要等待它执行完毕再执行。锁是当前对象this-因为对象是jvm-堆里面" class="headerlink" title="当对象同时多个synchronzied 方法，当某一时刻内，只要一个线程去调用其中的一个synchronzied 方法 其他线都要等待它执行完毕再执行。锁是当前对象this  因为对象是jvm 堆里面"></a>当对象同时多个synchronzied 方法，当某一时刻内，只要一个线程去调用其中的一个synchronzied 方法 其他线都要等待它执行完毕再执行。锁是当前对象this  因为对象是jvm 堆里面</h5><h5 id="当没有产生竞争时候，各自拿自己锁的执行。"><a href="#当没有产生竞争时候，各自拿自己锁的执行。" class="headerlink" title="当没有产生竞争时候，各自拿自己锁的执行。"></a>当没有产生竞争时候，各自拿自己锁的执行。</h5><h5 id="static-sychronzied-锁的是当前-类型模板。class-类锁-jvm-的方法区里面-只有唯一-一个"><a href="#static-sychronzied-锁的是当前-类型模板。class-类锁-jvm-的方法区里面-只有唯一-一个" class="headerlink" title="static sychronzied   锁的是当前 类型模板。class  (类锁)  jvm 的方法区里面   只有唯一 一个"></a>static sychronzied   锁的是当前 类型模板。class  (类锁)  jvm 的方法区里面   只有唯一 一个</h5><h5 id="对-同步代码块-锁的-sychronzied-括号的对象"><a href="#对-同步代码块-锁的-sychronzied-括号的对象" class="headerlink" title="对 同步代码块 锁的 sychronzied   括号的对象"></a>对 同步代码块 锁的 sychronzied   括号的对象</h5><h5 id="总之根据锁不同，分析是对象锁还是，类锁，或者同步代码块，如果不同锁，不那么不会有竞争关系，各自执行各自互不相干扰，使用锁的原则用无锁尽量，实在不行就同代码块，在不行使用对象-，最后才考虑类锁。锁粒度大小排序-到大-无锁-lt-同步代码块-lt-对象锁-lt-类锁"><a href="#总之根据锁不同，分析是对象锁还是，类锁，或者同步代码块，如果不同锁，不那么不会有竞争关系，各自执行各自互不相干扰，使用锁的原则用无锁尽量，实在不行就同代码块，在不行使用对象-，最后才考虑类锁。锁粒度大小排序-到大-无锁-lt-同步代码块-lt-对象锁-lt-类锁" class="headerlink" title="==总之根据锁不同，分析是对象锁还是，类锁，或者同步代码块，如果不同锁，不那么不会有竞争关系，各自执行各自互不相干扰，使用锁的原则用无锁尽量，实在不行就同代码块，在不行使用对象 ，最后才考虑类锁。锁粒度大小排序 到大   无锁    < 同步代码块  < 对象锁   < 类锁=="></a>==总之根据锁不同，分析是对象锁还是，类锁，或者同步代码块，如果不同锁，不那么不会有竞争关系，各自执行各自互不相干扰，使用锁的原则用无锁尽量，实在不行就同代码块，在不行使用对象 ，最后才考虑类锁。锁粒度大小排序 到大   无锁    &lt; 同步代码块  &lt; 对象锁   &lt; 类锁==</h5><h5 id="同步代码-反编译看-是用-javap-c-查看-底层sychronized-morritorenter-和monitorexit-但为啥会两个-monitorexit"><a href="#同步代码-反编译看-是用-javap-c-查看-底层sychronized-morritorenter-和monitorexit-但为啥会两个-monitorexit" class="headerlink" title="==同步代码 反编译看 是用  javap  -c   查看  底层sychronized  morritorenter   和monitorexit,但为啥会两个 monitorexit=="></a>==同步代码 反编译看 是用  javap  -c   查看  底层sychronized  morritorenter   和monitorexit,但为啥会两个 monitorexit==</h5><h6 id="是唯一正常情况获得执行完毕释放锁，但要异常情况也可以释放锁。所以加两个的-monitorexit，二对象锁和类型-它们反编译之后可以看-ACC-SYCHRONIZED-以及类锁"><a href="#是唯一正常情况获得执行完毕释放锁，但要异常情况也可以释放锁。所以加两个的-monitorexit，二对象锁和类型-它们反编译之后可以看-ACC-SYCHRONIZED-以及类锁" class="headerlink" title="是唯一正常情况获得执行完毕释放锁，但要异常情况也可以释放锁。所以加两个的 monitorexit，二对象锁和类型 它们反编译之后可以看  ACC_SYCHRONIZED ,以及类锁"></a>是唯一正常情况获得执行完毕释放锁，但要异常情况也可以释放锁。所以加两个的 monitorexit，二对象锁和类型 它们反编译之后可以看  ACC_SYCHRONIZED ,以及类锁</h6><h4 id="公平锁-和非公平锁"><a href="#公平锁-和非公平锁" class="headerlink" title="==公平锁 和非公平锁=="></a>==公平锁 和非公平锁==</h4><h5 id="公平锁是指多个线程按照申请锁的顺序来获取锁，类似于排队买饭，先来后到，先来先服务，就是公平的，也就是队列"><a href="#公平锁是指多个线程按照申请锁的顺序来获取锁，类似于排队买饭，先来后到，先来先服务，就是公平的，也就是队列" class="headerlink" title="公平锁是指多个线程按照申请锁的顺序来获取锁，类似于排队买饭，先来后到，先来先服务，就是公平的，也就是队列"></a>公平锁是指多个线程按照申请锁的顺序来获取锁，类似于排队买饭，先来后到，先来先服务，就是公平的，也就是队列</h5><h5 id="非公平锁-是指多个线程不会-按照申请锁的顺序来获取锁，有的锁-插队，而且插队执行之后，可能会继续再来排队又插队相比其他线程不公平的抢夺cpu资源的。"><a href="#非公平锁-是指多个线程不会-按照申请锁的顺序来获取锁，有的锁-插队，而且插队执行之后，可能会继续再来排队又插队相比其他线程不公平的抢夺cpu资源的。" class="headerlink" title="非公平锁 是指多个线程不会    按照申请锁的顺序来获取锁，有的锁 插队，而且插队执行之后，可能会继续再来排队又插队相比其他线程不公平的抢夺cpu资源的。"></a>非公平锁 是指多个线程不会    按照申请锁的顺序来获取锁，有的锁 插队，而且插队执行之后，可能会继续再来排队又插队相比其他线程不公平的抢夺cpu资源的。</h5><h5 id="为啥默认是非公平的，以及什么时候用公平什么时候用非公平"><a href="#为啥默认是非公平的，以及什么时候用公平什么时候用非公平" class="headerlink" title="==为啥默认是非公平的，以及什么时候用公平什么时候用非公平=="></a>==为啥默认是非公平的，以及什么时候用公平什么时候用非公平==</h5><h6 id="首先默认使用非公平的时候，系统减少线程切换次数。提高系统的性能，对于何为使用公平和非公平的。那根据具体业务具体分析例如医院挂号的可以使用公平保证没有每个人都被叫到，非公平例如等红绿灯时候主干道的车辆比较多，需要放行车辆次数多，次要干道车流少。甚至没有车。所以使用非公平让交通流畅"><a href="#首先默认使用非公平的时候，系统减少线程切换次数。提高系统的性能，对于何为使用公平和非公平的。那根据具体业务具体分析例如医院挂号的可以使用公平保证没有每个人都被叫到，非公平例如等红绿灯时候主干道的车辆比较多，需要放行车辆次数多，次要干道车流少。甚至没有车。所以使用非公平让交通流畅" class="headerlink" title="首先默认使用非公平的时候，系统减少线程切换次数。提高系统的性能，对于何为使用公平和非公平的。那根据具体业务具体分析例如医院挂号的可以使用公平保证没有每个人都被叫到，非公平例如等红绿灯时候主干道的车辆比较多，需要放行车辆次数多，次要干道车流少。甚至没有车。所以使用非公平让交通流畅"></a>首先默认使用非公平的时候，系统减少线程切换次数。提高系统的性能，对于何为使用公平和非公平的。那根据具体业务具体分析例如医院挂号的可以使用公平保证没有每个人都被叫到，非公平例如等红绿灯时候主干道的车辆比较多，需要放行车辆次数多，次要干道车流少。甚至没有车。所以使用非公平让交通流畅</h6><h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="==偏向锁=="></a>==偏向锁==</h4><h5 id="偏向锁-单线程竞争当线程A第一次竞争到锁时，通过操作修改Mark-Word中的偏向线程ID、偏向模式如果不存在其他线程竞争，那么持有偏向锁的线程将永远不需要进行同步。（-减少用户态内核态切换-）"><a href="#偏向锁-单线程竞争当线程A第一次竞争到锁时，通过操作修改Mark-Word中的偏向线程ID、偏向模式如果不存在其他线程竞争，那么持有偏向锁的线程将永远不需要进行同步。（-减少用户态内核态切换-）" class="headerlink" title="偏向锁:单线程竞争当线程A第一次竞争到锁时，通过操作修改Mark Word中的偏向线程ID、偏向模式如果不存在其他线程竞争，那么持有偏向锁的线程将永远不需要进行同步。（==减少用户态内核态切换==）"></a>偏向锁:单线程竞争当线程A第一次竞争到锁时，通过操作修改Mark Word中的偏向线程ID、偏向模式如果不存在其他线程竞争，那么持有偏向锁的线程将永远不需要进行同步。（==减少用户态内核态切换==）</h5><h5 id="作用：-当一段同步代码一直被同一个线程多次访问，由于只有一个线程那幺该线程在后续访问时便会自动获得锁。"><a href="#作用：-当一段同步代码一直被同一个线程多次访问，由于只有一个线程那幺该线程在后续访问时便会自动获得锁。" class="headerlink" title="作用： 当一段同步代码一直被同一个线程多次访问，由于只有一个线程那幺该线程在后续访问时便会自动获得锁。"></a>作用： 当一段同步代码一直被同一个线程多次访问，由于只有一个线程那幺该线程在后续访问时便会自动获得锁。</h5><h5 id="理论落地"><a href="#理论落地" class="headerlink" title="理论落地"></a>理论落地</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">
在实际应用运行过程中发现，“锁总是同一个线程持有，很少发生竞争”，也就是说锁总是被第一个占用他的线程拥有，这个线程就是锁的偏向线程。
那么只需要在锁第一次被拥有的时候，记录下偏向线程ID。这样偏向线程就一直持有着锁(后续这个线程进入和退出这段加了同步锁的代码块时，不需要再次加锁和释放锁。而是直接会去检查锁的MarkWord里面是不是放的自己的线程ID)。如果相等，表示偏向锁是偏向于当前线程的，就不需要再尝试获得锁了，直到竞争发生才释放锁。以后每次同步，检查锁的偏向线程D与当前线程ID是否一致，如果一致直接进入同步。无需每次加锁解锁都去CAS更新对象头。如果自始至终使用锁的线程只有一个，很明显偏向锁几乎没有额外开销，性能极高。
如果不等，表示发生了竞争，锁已经不是总是偏向于同一个线程了，这个时候会尝试使用CAS来替换MarkWord里面的线程ID为新线程的ID，
竞争成功，表示之前的线程不存在了， Markword里面的线程ID为新线程的ID，锁不会升级，仍然为偏向锁，竞争失败，这时候可能需要升级变为轻量级锁，才能保证线程间公平竞争锁。注意，偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程是不会主动释放偏向锁的。技术实现:
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="技术实现："><a href="#技术实现：" class="headerlink" title="技术实现："></a>技术实现：</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">一个synchronized方法被一个线程抢到了锁时，那这个方法所在的对象就会在其所在的Mak Word中将偏向锁修改状态位，同时还会有占用前54位来存储线程指针作为标识。若该线程再次访问同一个synchronized方法时，该线程只需去对象头的Mark Word 中去判断一下是否有偏向锁指向本身的ID，无需再进入 Monitor 去竞争对象了。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="轻量锁"><a href="#轻量锁" class="headerlink" title="==轻量锁=="></a>==轻量锁==</h4><h5 id="定义：多线程竞争，但是任意时刻最多只有一个线程竞争，即不存在锁竞争太过激烈的情况，也就没有线程阻寨。"><a href="#定义：多线程竞争，但是任意时刻最多只有一个线程竞争，即不存在锁竞争太过激烈的情况，也就没有线程阻寨。" class="headerlink" title="定义：多线程竞争，但是任意时刻最多只有一个线程竞争，即不存在锁竞争太过激烈的情况，也就没有线程阻寨。"></a>定义：多线程竞争，但是任意时刻最多只有一个线程竞争，即不存在锁竞争太过激烈的情况，也就没有线程阻寨。</h5><h5 id="作用：有线程来参与锁的竞争，但是获取锁的冲突时间极短本质就是自旋锁CAS"><a href="#作用：有线程来参与锁的竞争，但是获取锁的冲突时间极短本质就是自旋锁CAS" class="headerlink" title="作用：有线程来参与锁的竞争，但是获取锁的冲突时间极短本质就是自旋锁CAS"></a>作用：有线程来参与锁的竞争，但是获取锁的冲突时间极短本质就是自旋锁CAS</h5><h4 id="重量级锁"><a href="#重量级锁" class="headerlink" title="==重量级锁=="></a>==重量级锁==</h4><h5 id="重量级锁原理"><a href="#重量级锁原理" class="headerlink" title="重量级锁原理"></a>重量级锁原理</h5><h6 id="指向互斥量-重量级锁-的指针"><a href="#指向互斥量-重量级锁-的指针" class="headerlink" title="指向互斥量 (重量级锁)的指针"></a>指向互斥量 (重量级锁)的指针</h6><p>Java中synchronized的重量级锁，是基于进入和退出Monitor对象实现的。在编译时会将同步块的开始位置插入monitor enter指令，在结束位置插入monitor exit指令。<br>当线程执行到monitor enter指令时，会尝试获取对象所对应的Monitor所有权，如果获取到了，即获取到了锁，会在Monitor的owner中存放当前线程的id，这样它将处于锁定状态，除非退出同步块，否则其他线程无法获取到这个Monitor。</p>
<h4 id="自旋锁"><a href="#自旋锁" class="headerlink" title="==自旋锁=="></a>==自旋锁==</h4><h5 id="自旋锁-spinlock"><a href="#自旋锁-spinlock" class="headerlink" title="自旋锁 (spinlock)"></a>自旋锁 (spinlock)</h5><h5 id="CAS-是实现自旋锁的基础，CAS-利用-CPU-指令保证了操作的原子性，以达到锁的效果，至于自旋呢，看字面意思也很明白，自己旋转。是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，当线程发现锁被占用时，会不断循环判断锁的状态，直到获取。这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU"><a href="#CAS-是实现自旋锁的基础，CAS-利用-CPU-指令保证了操作的原子性，以达到锁的效果，至于自旋呢，看字面意思也很明白，自己旋转。是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，当线程发现锁被占用时，会不断循环判断锁的状态，直到获取。这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU" class="headerlink" title="CAS 是实现自旋锁的基础，CAS 利用 CPU 指令保证了操作的原子性，以达到锁的效果，至于自旋呢，看字面意思也很明白，自己旋转。是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，当线程发现锁被占用时，会不断循环判断锁的状态，直到获取。这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU"></a>CAS 是实现自旋锁的基础，CAS 利用 CPU 指令保证了操作的原子性，以达到锁的效果，至于自旋呢，看字面意思也很明白，自己旋转。是指尝试获取锁的线程不会立即阻塞，而是采用循环的方式去尝试获取锁，当线程发现锁被占用时，会不断循环判断锁的状态，直到获取。这样的好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU</h5><h5 id="CAS-是实现自旋锁的基础，自旋翻译成人话就是循环，一般是用一个无限循环实现。这样一来，一个无限循环中，执行一个CAS-操作，"><a href="#CAS-是实现自旋锁的基础，自旋翻译成人话就是循环，一般是用一个无限循环实现。这样一来，一个无限循环中，执行一个CAS-操作，" class="headerlink" title="CAS 是实现自旋锁的基础，自旋翻译成人话就是循环，一般是用一个无限循环实现。这样一来，一个无限循环中，执行一个CAS 操作，"></a>CAS 是实现自旋锁的基础，自旋翻译成人话就是循环，一般是用一个无限循环实现。这样一来，一个无限循环中，执行一个CAS 操作，</h5><p>当操作成功返回 true 时，循环结束;<br>当返回 false 时，接着执行循环，继续尝试 CAS 操作，直到返回 true。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/***
 * 实现一个自旋锁，复习CAS思想
 * 自旋锁好处: 循坏比较获取没有类似wait的阻塞
 * 水
 * 通过CAS操作完成自旋锁，A线程先进来调用myLock方法自己持有锁5秒钟，B随后进来后发现￥当前有线程持有锁，所以只能通过自旋等待，直到A释放锁后B随后抢到。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockSprnk</span> <span class="token punctuation">{</span>

    <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> atomicReference<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自定义类的原子引用</span>

    <span class="token comment">/**
     * 加锁方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockAtmot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" come  in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>thread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//判断 是否有线程，没有就把当前放进去</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解锁方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLockAtomit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自旋看是否当前线程  是置空</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"解锁成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LockSprnk</span> lockSprnk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LockSprnk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            lockSprnk<span class="token punctuation">.</span><span class="token function">lockAtmot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//休眠5毫秒</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            lockSprnk<span class="token punctuation">.</span><span class="token function">unLockAtomit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//暂停5秒</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>


        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            lockSprnk<span class="token punctuation">.</span><span class="token function">lockAtmot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            lockSprnk<span class="token punctuation">.</span><span class="token function">unLockAtomit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="CAS-的缺点：CPU的空转-以及-ABA-的问题（这又会引出时间戳的原子类）"><a href="#CAS-的缺点：CPU的空转-以及-ABA-的问题（这又会引出时间戳的原子类）" class="headerlink" title="CAS 的缺点：CPU的空转 以及 ABA 的问题（这又会引出时间戳的原子类）"></a>CAS 的缺点：CPU的空转 以及 ABA 的问题（这又会引出时间戳的原子类）</h6><h4 id="读写锁"><a href="#读写锁" class="headerlink" title="==读写锁=="></a>==读写锁==</h4><h5 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h5><h5 id="读写锁定义为-一个资源能够被多个读线程访问，或者被一个写线程访问，但是不能同时存在读写线程。（读写互斥，读读共享，读是独占锁读未完成写锁抢不到）"><a href="#读写锁定义为-一个资源能够被多个读线程访问，或者被一个写线程访问，但是不能同时存在读写线程。（读写互斥，读读共享，读是独占锁读未完成写锁抢不到）" class="headerlink" title="读写锁定义为:一个资源能够被多个读线程访问，或者被一个写线程访问，但是不能同时存在读写线程。（读写互斥，读读共享，读是独占锁读未完成写锁抢不到）"></a>读写锁定义为:一个资源能够被多个读线程访问，或者被一个写线程访问，但是不能同时存在读写线程。（读写互斥，读读共享，读是独占锁读未完成写锁抢不到）</h5><h4 id="邮戳锁"><a href="#邮戳锁" class="headerlink" title="==邮戳锁=="></a>==邮戳锁==</h4><h5 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h5><h6 id="ReentrantReadWriteLock的读锁被占用的时候，其他线程尝试获取写锁的时候会被阻塞。但是，StampedLock采取乐观获取后，其他线程尝试获取写锁时不会被阻塞，这其实是对读锁的优化，所以，在获取乐观读锁后，还需要对结果进行校验。"><a href="#ReentrantReadWriteLock的读锁被占用的时候，其他线程尝试获取写锁的时候会被阻塞。但是，StampedLock采取乐观获取后，其他线程尝试获取写锁时不会被阻塞，这其实是对读锁的优化，所以，在获取乐观读锁后，还需要对结果进行校验。" class="headerlink" title="ReentrantReadWriteLock的读锁被占用的时候，其他线程尝试获取写锁的时候会被阻塞。但是，StampedLock采取乐观获取后，其他线程尝试获取写锁时不会被阻塞，这其实是对读锁的优化，所以，在获取乐观读锁后，还需要对结果进行校验。"></a>ReentrantReadWriteLock的读锁被占用的时候，其他线程尝试获取写锁的时候会被阻塞。但是，StampedLock采取乐观获取后，其他线程尝试获取写锁时不会被阻塞，这其实是对读锁的优化，所以，在获取乐观读锁后，还需要对结果进行校验。</h6><h4 id="锁的降级"><a href="#锁的降级" class="headerlink" title="==锁的降级=="></a>==锁的降级==</h4><h5 id="写锁的降级，降级成为了读锁"><a href="#写锁的降级，降级成为了读锁" class="headerlink" title="写锁的降级，降级成为了读锁"></a>写锁的降级，降级成为了读锁</h5><ul>
<li>1 如果同一个线程持有了写锁，在没有释放写锁的情况下，它还可以继续获得读锁。这就是写锁的降级，降级成为了读锁。</li>
<li>2 规则惯例，先获取写锁，然后获取读锁，再释放写锁的 次序</li>
<li> 3 如果释放了写锁，那么就完全转换为读锁。</li>
</ul>
<h4 id="可重入锁（递归锁）"><a href="#可重入锁（递归锁）" class="headerlink" title="==可重入锁（递归锁）=="></a>==可重入锁（递归锁）==</h4><h5 id="指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码，在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。（前提获得同一把锁）"><a href="#指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码，在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。（前提获得同一把锁）" class="headerlink" title="指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码，在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。（前提获得同一把锁）"></a>指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码，在同一个线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。（前提获得同一把锁）</h5><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E9%80%92%E5%BD%92%E9%94%81.png" alt="递归锁"></p>
<h5 id="可重入锁-分为隐式锁-和-显示锁-：-sychronized-关键字-使用的锁-默认可重入锁，显示锁-reentrLock-的lock-和unlock-锁的要成对出现，不然导致不能有效释放锁以至于线程被阻塞。"><a href="#可重入锁-分为隐式锁-和-显示锁-：-sychronized-关键字-使用的锁-默认可重入锁，显示锁-reentrLock-的lock-和unlock-锁的要成对出现，不然导致不能有效释放锁以至于线程被阻塞。" class="headerlink" title="可重入锁  分为隐式锁 和 显示锁 ： sychronized 关键字 使用的锁 默认可重入锁，显示锁      reentrLock   的lock 和unlock 锁的要成对出现，不然导致不能有效释放锁以至于线程被阻塞。"></a>可重入锁  分为隐式锁 和 显示锁 ： sychronized 关键字 使用的锁 默认可重入锁，显示锁      reentrLock   的lock 和unlock 锁的要成对出现，不然导致不能有效释放锁以至于线程被阻塞。</h5><h4 id="死锁"><a href="#死锁" class="headerlink" title="==死锁=="></a>==死锁==</h4><h5 id="死锁的概念：两个或两个的线程争夺资源，而造成的相互等待"><a href="#死锁的概念：两个或两个的线程争夺资源，而造成的相互等待" class="headerlink" title="死锁的概念：两个或两个的线程争夺资源，而造成的相互等待"></a>死锁的概念：两个或两个的线程争夺资源，而造成的相互等待</h5><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E6%AD%BB%E9%94%81%E7%8E%B0%E8%B1%A1.png" alt="死锁现象"></p>
<h5 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Object</span> a<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Object</span> b<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">new</span>  <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>

           <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" A想想拿到b锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">try</span><span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
               <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
                   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" B想拿到A锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">new</span>  <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>

          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" B想想拿到A锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" A想拿到B锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="死锁的诊断-JPS-l-列所有的线程id-再根据-jstack-线程id好诊断"><a href="#死锁的诊断-JPS-l-列所有的线程id-再根据-jstack-线程id好诊断" class="headerlink" title="死锁的诊断 JPS  -l  列所有的线程id    再根据 jstack  线程id好诊断"></a>死锁的诊断 JPS  -l  列所有的线程id    再根据 jstack  线程id好诊断</h5><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E6%AD%BB%E9%94%81%E8%AF%8A%E6%96%AD.png" alt="死锁图例1"></p>
<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E6%AD%BB%E9%94%812.png" alt="死锁图例2"></p>
<h5 id="图形化诊断-死锁"><a href="#图形化诊断-死锁" class="headerlink" title="图形化诊断 死锁"></a>图形化诊断 死锁</h5><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%AD%BB%E9%94%811.png" alt="图形化死锁1"></p>
<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%AD%BB%E9%94%812.png" alt="图形化死锁2"></p>
<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%9B%BE%E5%BD%A2%E5%8C%96%E6%AD%BB%E9%94%814.png" alt="图形化死锁4"></p>
<h3 id="线程中断机制"><a href="#线程中断机制" class="headerlink" title="线程中断机制"></a>线程中断机制</h3><h5 id="考点：线程如何中断运行-请用简单的code-编写。当调用-interrupt-是否马上停止线程呢-，对比一下isinterrupt和静态interrupt他们的方法有什么区别"><a href="#考点：线程如何中断运行-请用简单的code-编写。当调用-interrupt-是否马上停止线程呢-，对比一下isinterrupt和静态interrupt他们的方法有什么区别" class="headerlink" title="==考点：线程如何中断运行 ,请用简单的code 编写。当调用  interrupt()是否马上停止线程呢   ，对比一下isinterrupt和静态interrupt他们的方法有什么区别=="></a>==考点：线程如何中断运行 ,请用简单的code 编写。当调用  interrupt()是否马上停止线程呢   ，对比一下isinterrupt和静态interrupt他们的方法有什么区别==</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//是否中断</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程+"</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">try</span><span class="token punctuation">{</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//睡眠中断异常的 导致死循环 一定要再调用一次，把标志位改过程（重点）原因是把t2中断标志位给清除了，只有InterruptedException 异常就会中断标志位标识</span>
              <span class="token punctuation">}</span>
              <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程没有停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// System.out.println(Thread.currentThread().isInterrupted());</span>
      <span class="token keyword">try</span><span class="token punctuation">{</span>
          <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MICROSECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
          t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//中断 调用这个方法 变更中断的标志位（中断是一种协商机制，不是立即停止线程的活得，而是被中断的线程自己停止）</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="中断的总结-具体来说，当对一个线程，调用-interrupt-时"><a href="#中断的总结-具体来说，当对一个线程，调用-interrupt-时" class="headerlink" title="中断的总结:具体来说，当对一个线程，调用 interrupt() 时:"></a>中断的总结:具体来说，当对一个线程，调用 interrupt() 时:</h6><p>1如果线程处于正常活动状态，那么会将该线程的中断标志设置为 true，仅此而已。被设置中断标志的线程将继续正常运行，不受影响。所以，interrupt() 并不能真正的中断线程，需要被调用的线程自己进行配合才行<br>2如果线程处于被阻塞状态(例如处于sleep,wait, join 等状态)，在别的线程中调用当前线程对象的interrupt方法,那么线程将立即退出被阻塞状态，并抛出一个InterruptedException异常。</p>
<h6 id="中断interrupt-的静态-方法他-会中两个事情，一个测试当前线程是否被中断了，还有一个是将当前线程中断把标志位改为false-。清除线程的中断状态-，实例方法isterrup-和interrup-它们底层都是调用的-相同的方法，只不过静态方法主动清除标志位。"><a href="#中断interrupt-的静态-方法他-会中两个事情，一个测试当前线程是否被中断了，还有一个是将当前线程中断把标志位改为false-。清除线程的中断状态-，实例方法isterrup-和interrup-它们底层都是调用的-相同的方法，只不过静态方法主动清除标志位。" class="headerlink" title="中断interrupt 的静态 方法他 会中两个事情，一个测试当前线程是否被中断了，还有一个是将当前线程中断把标志位改为false 。清除线程的中断状态 ，实例方法isterrup  和interrup 它们底层都是调用的 相同的方法，只不过静态方法主动清除标志位。"></a>中断interrupt 的静态 方法他 会中两个事情，一个测试当前线程是否被中断了，还有一个是将当前线程中断把标志位改为false 。清除线程的中断状态 ，实例方法isterrup  和interrup 它们底层都是调用的 相同的方法，只不过静态方法主动清除标志位。</h6><h3 id="LockSuppot"><a href="#LockSuppot" class="headerlink" title="LockSuppot"></a>LockSuppot</h3><h4 id="LockSupport-是前面的对线程的等待和唤醒-的优化，前面Object自带的-wait-和notfiy-Lock中的-await-和signal"><a href="#LockSupport-是前面的对线程的等待和唤醒-的优化，前面Object自带的-wait-和notfiy-Lock中的-await-和signal" class="headerlink" title="LockSupport 是前面的对线程的等待和唤醒 的优化，前面Object自带的 wait 和notfiy      Lock中的 await 和signal"></a>LockSupport 是前面的对线程的等待和唤醒 的优化，前面Object自带的 wait 和notfiy      Lock中的 await 和signal</h4><h4 id="sychorizied-里面-wait-notfiy-需要成对出现，并且放在同步sychcorized-修饰的代码块里面。否则也会报异常。condition-中-lock-await-和signal-也是一样要-lock-unlock-里面的-顺序也不能调换。由此优化的LockSupport-背景。"><a href="#sychorizied-里面-wait-notfiy-需要成对出现，并且放在同步sychcorized-修饰的代码块里面。否则也会报异常。condition-中-lock-await-和signal-也是一样要-lock-unlock-里面的-顺序也不能调换。由此优化的LockSupport-背景。" class="headerlink" title="sychorizied    里面 wait  notfiy  需要成对出现，并且放在同步sychcorized 修饰的代码块里面。否则也会报异常。condition 中 lock await 和signal 也是一样要 lock   unlock 里面的 顺序也不能调换。由此优化的LockSupport  背景。"></a>sychorizied    里面 wait  notfiy  需要成对出现，并且放在同步sychcorized 修饰的代码块里面。否则也会报异常。condition 中 lock await 和signal 也是一样要 lock   unlock 里面的 顺序也不能调换。由此优化的LockSupport  背景。</h4><h5 id="LockSupport是用来创建锁和其他同步类的基本线程阻寒原语。一个线程阻塞工具类，所有的方法都是静态方法，可以让线程在任意位置阻塞，阻塞之后也有对应的唤醒方法。归根结-ockSupport是LockSupport调用的Unsafe中的native代码。"><a href="#LockSupport是用来创建锁和其他同步类的基本线程阻寒原语。一个线程阻塞工具类，所有的方法都是静态方法，可以让线程在任意位置阻塞，阻塞之后也有对应的唤醒方法。归根结-ockSupport是LockSupport调用的Unsafe中的native代码。" class="headerlink" title="LockSupport是用来创建锁和其他同步类的基本线程阻寒原语。一个线程阻塞工具类，所有的方法都是静态方法，可以让线程在任意位置阻塞，阻塞之后也有对应的唤醒方法。归根结_ockSupport是LockSupport调用的Unsafe中的native代码。"></a>LockSupport是用来创建锁和其他同步类的基本线程阻寒原语。一个线程阻塞工具类，所有的方法都是静态方法，可以让线程在任意位置阻塞，阻塞之后也有对应的唤醒方法。归根结_ockSupport是LockSupport调用的Unsafe中的native代码。</h5><h5 id="ockSupport-提供park-和unpark-方法实现阻塞线程和解除线程阻塞的过程ockSupport和每个使用它的线程都有一个许可-permit-关联。每个线程都有一个相关的permit-permit最多只有一个，重复调用unpark也不会积累凭证。"><a href="#ockSupport-提供park-和unpark-方法实现阻塞线程和解除线程阻塞的过程ockSupport和每个使用它的线程都有一个许可-permit-关联。每个线程都有一个相关的permit-permit最多只有一个，重复调用unpark也不会积累凭证。" class="headerlink" title="_ockSupport 提供park()和unpark()方法实现阻塞线程和解除线程阻塞的过程ockSupport和每个使用它的线程都有一个许可(permit)关联。每个线程都有一个相关的permit, permit最多只有一个，重复调用unpark也不会积累凭证。"></a>_ockSupport 提供park()和unpark()方法实现阻塞线程和解除线程阻塞的过程ockSupport和每个使用它的线程都有一个许可(permit)关联。每个线程都有一个相关的permit, permit最多只有一个，重复调用unpark也不会积累凭证。</h5><h5 id="形象的理解"><a href="#形象的理解" class="headerlink" title="形象的理解"></a>形象的理解</h5><h5 id="线程阻塞需要消耗凭证-permit-，这个凭证最多只有1个。当调用-park方法时-如果有凭证，则会直接消耗掉这个凭证然后正常退出"><a href="#线程阻塞需要消耗凭证-permit-，这个凭证最多只有1个。当调用-park方法时-如果有凭证，则会直接消耗掉这个凭证然后正常退出" class="headerlink" title="线程阻塞需要消耗凭证(permit)，这个凭证最多只有1个。当调用 park方法时 如果有凭证，则会直接消耗掉这个凭证然后正常退出;"></a>线程阻塞需要消耗凭证(permit)，这个凭证最多只有1个。当调用 park方法时 如果有凭证，则会直接消耗掉这个凭证然后正常退出;</h5><h5 id="如果无凭证，就必须阻寒等待凭证可用"><a href="#如果无凭证，就必须阻寒等待凭证可用" class="headerlink" title="如果无凭证，就必须阻寒等待凭证可用;"></a>如果无凭证，就必须阻寒等待凭证可用;</h5><h5 id="而unpark则相反，它会增加一个凭证，但凭证最多只能有1个，累加无效。"><a href="#而unpark则相反，它会增加一个凭证，但凭证最多只能有1个，累加无效。" class="headerlink" title="而unpark则相反，它会增加一个凭证，但凭证最多只能有1个，累加无效。"></a>而unpark则相反，它会增加一个凭证，但凭证最多只能有1个，累加无效。</h5><h5 id="考点-为什么可以突破wait-notify的原有调用顺序-为什么唤醒两次后阻塞两次"><a href="#考点-为什么可以突破wait-notify的原有调用顺序-为什么唤醒两次后阻塞两次" class="headerlink" title="==考点 为什么可以突破wait/notify的原有调用顺序? 为什么唤醒两次后阻塞两次=="></a>==考点 为什么可以突破wait/notify的原有调用顺序? 为什么唤醒两次后阻塞两次==</h5><h6 id="为什么可以突破wait-notify的原有调用顺序"><a href="#为什么可以突破wait-notify的原有调用顺序" class="headerlink" title="为什么可以突破wait/notify的原有调用顺序?"></a>为什么可以突破wait/notify的原有调用顺序?</h6><h6 id="因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。"><a href="#因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。" class="headerlink" title="因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。"></a>因为unpark获得了一个凭证，之后再调用park方法，就可以名正言顺的凭证消费，故不会阻塞。</h6><h6 id="先发放了凭证后续可以畅通无阻。"><a href="#先发放了凭证后续可以畅通无阻。" class="headerlink" title="先发放了凭证后续可以畅通无阻。"></a>先发放了凭证后续可以畅通无阻。</h6><h6 id="为什么唤醒两次后阻塞两次，但最终结果还会阻塞线程-因为凭证的数量最多为-1，连续调用两次-unpark-和-调用一次-unpark-效果一样，只会增加一个凭"><a href="#为什么唤醒两次后阻塞两次，但最终结果还会阻塞线程-因为凭证的数量最多为-1，连续调用两次-unpark-和-调用一次-unpark-效果一样，只会增加一个凭" class="headerlink" title="为什么唤醒两次后阻塞两次，但最终结果还会阻塞线程?因为凭证的数量最多为 1，连续调用两次 unpark 和 调用一次 unpark 效果一样，只会增加一个凭"></a>为什么唤醒两次后阻塞两次，但最终结果还会阻塞线程?因为凭证的数量最多为 1，连续调用两次 unpark 和 调用一次 unpark 效果一样，只会增加一个凭</h6><h6 id="证-而调用两次-park却需要消费两个凭证，证不够，不能放行。"><a href="#证-而调用两次-park却需要消费两个凭证，证不够，不能放行。" class="headerlink" title="证:而调用两次 park却需要消费两个凭证，证不够，不能放行。"></a>证:而调用两次 park却需要消费两个凭证，证不够，不能放行。</h6><h5 id="为什么wait必须写在同步代码块中？"><a href="#为什么wait必须写在同步代码块中？" class="headerlink" title="==为什么wait必须写在同步代码块中？=="></a>==为什么wait必须写在同步代码块中？==</h5><h6 id="避免-CPU-切换到其他程，而其他线程又提前执行了-notify-方法，那这样就达不到我们的预期（先-wait-再由其他程来唤醒），所以需要一个同步锁来保护"><a href="#避免-CPU-切换到其他程，而其他线程又提前执行了-notify-方法，那这样就达不到我们的预期（先-wait-再由其他程来唤醒），所以需要一个同步锁来保护" class="headerlink" title="避免 CPU 切换到其他程，而其他线程又提前执行了 notify 方法，那这样就达不到我们的预期（先 wait 再由其他程来唤醒），所以需要一个同步锁来保护"></a>避免 CPU 切换到其他程，而其他线程又提前执行了 notify 方法，那这样就达不到我们的预期（先 wait 再由其他程来唤醒），所以需要一个同步锁来保护</h6><h5 id="sleep-与wait-的区别？"><a href="#sleep-与wait-的区别？" class="headerlink" title="==sleep()与wait()的区别？=="></a>==sleep()与wait()的区别？==</h5><h6 id="主要有四个方面区别"><a href="#主要有四个方面区别" class="headerlink" title="主要有四个方面区别"></a>主要有四个方面区别</h6><ul>
<li>sleep() 属于Thread类，wait() 属于Object类</li>
<li>sleep() 不会释放对象锁，wait() 会释放对象锁</li>
<li>sleep() 必须指定时间，wait() 可指定也可以不指定</li>
<li>sleep() 可以使用在任何代码块，wait() 必须在同步方法或同步代码块中使用</li>
</ul>
<h5 id="为什么wait要定义在Object中而不定义在Thread中？"><a href="#为什么wait要定义在Object中而不定义在Thread中？" class="headerlink" title="==为什么wait要定义在Object中而不定义在Thread中？=="></a>==为什么wait要定义在Object中而不定义在Thread中？==</h5><h6 id="Java的锁是对象级别的，不是线程级别的"><a href="#Java的锁是对象级别的，不是线程级别的" class="headerlink" title="Java的锁是对象级别的，不是线程级别的"></a>Java的锁是对象级别的，不是线程级别的</h6><h6 id="sleep-休眠指的就是线程休眠，所以在Thread类"><a href="#sleep-休眠指的就是线程休眠，所以在Thread类" class="headerlink" title="sleep() 休眠指的就是线程休眠，所以在Thread类"></a>sleep() 休眠指的就是线程休眠，所以在Thread类</h6><h5 id="Sychronized和lock有什么区别？用新的Lock有什么好处？举例说说"><a href="#Sychronized和lock有什么区别？用新的Lock有什么好处？举例说说" class="headerlink" title="==Sychronized和lock有什么区别？用新的Lock有什么好处？举例说说=="></a>==Sychronized和lock有什么区别？用新的Lock有什么好处？举例说说==</h5><ul>
<li><p>原始构成：</p>
<ul>
<li><p>Synchronized是关键字属于JVM层面monitorenter (底层是通过monitor对象来完成，其实和wait/notify等方法也依赖于monitor对象只有在同步块或者方法中才能调用wait/notify等方法)monitorExit(有两个，一个是正常退出一个是异常退出)</p>
</li>
<li><p>Lock是具体类 (java.utilconcurrentlocks.Lock) 是api层面的锁</p>
</li>
</ul>
</li>
<li><p>使用方法：</p>
<ul>
<li>synchronized不需要用户去手动释放锁，当synchronized代码执行完成后系统会自动让线程释放对锁的占用</li>
<li>ReentrantLock则需要用户去手动释放锁，若没有主动释放锁，就有可能导致出现死锁现象需要lock()和unlock()方法配合try/finally语句块来完成</li>
</ul>
</li>
<li><p>等待是否可中断</p>
<ul>
<li>Synchronized不可中断，除非抛出异常或者正常运行完成</li>
<li>除非抛出异常或者正常运行完成</li>
<li>设置超时方法tryLock(long timeoutTimeUnit unit)</li>
<li>lockInterruptibly()放代码块中，调用interrupt0)方法可中断</li>
</ul>
</li>
<li><p>锁绑定多个条件Condition</p>
<ul>
<li>synchronized没有</li>
<li>ReentrantLock用来实现分组唤醒需要唤醒的线程们，可以精确唤醒，而不是像synchronized要么随机唤醒一个先后曾要么唤醒全部线程。</li>
</ul>
</li>
</ul>
<h3 id="java内存模型-之-jMM"><a href="#java内存模型-之-jMM" class="headerlink" title="java内存模型 之 jMM"></a>java内存模型 之 jMM</h3><h4 id="因为有这么多级的缓存-cpu和物理主内存的速度不一致的-CPU的运行并不是直接操作内存而是先把内存里边的数据读到缓存，而内存的读和写操作的时候就会造成不一致的问题"><a href="#因为有这么多级的缓存-cpu和物理主内存的速度不一致的-CPU的运行并不是直接操作内存而是先把内存里边的数据读到缓存，而内存的读和写操作的时候就会造成不一致的问题" class="headerlink" title="因为有这么多级的缓存(cpu和物理主内存的速度不一致的).CPU的运行并不是直接操作内存而是先把内存里边的数据读到缓存，而内存的读和写操作的时候就会造成不一致的问题"></a>因为有这么多级的缓存(cpu和物理主内存的速度不一致的).CPU的运行并不是直接操作内存而是先把内存里边的数据读到缓存，而内存的读和写操作的时候就会造成不一致的问题</h4><h4 id="jVM规范中试图定义一种Java内存模型-java-Memory-Model，简称JMM-来屏蔽掉各种硬件和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。所以，推导出我们需要知道JMM"><a href="#jVM规范中试图定义一种Java内存模型-java-Memory-Model，简称JMM-来屏蔽掉各种硬件和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。所以，推导出我们需要知道JMM" class="headerlink" title="jVM规范中试图定义一种Java内存模型 java Memory Model，简称JMM)来屏蔽掉各种硬件和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。所以，推导出我们需要知道JMM"></a>jVM规范中试图定义一种Java内存模型 java Memory Model，简称JMM)来屏蔽掉各种硬件和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。所以，推导出我们需要知道JMM</h4><h4 id="JMM-Java内存模型Java-Memory-Mode，简称JMM-本身是一种抽象的概念并不真实存在它仅仅描述的是一组约定或规范，通过这组现范定义了程序中-尤其是多线程-各人变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关建技术点都是围绕多线程的原子性、可见性和有序性展开的。"><a href="#JMM-Java内存模型Java-Memory-Mode，简称JMM-本身是一种抽象的概念并不真实存在它仅仅描述的是一组约定或规范，通过这组现范定义了程序中-尤其是多线程-各人变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关建技术点都是围绕多线程的原子性、可见性和有序性展开的。" class="headerlink" title="JMM(Java内存模型Java Memory Mode，简称JMM)本身是一种抽象的概念并不真实存在它仅仅描述的是一组约定或规范，通过这组现范定义了程序中(尤其是多线程)各人变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关建技术点都是围绕多线程的原子性、可见性和有序性展开的。"></a>JMM(Java内存模型Java Memory Mode，简称JMM)本身是一种抽象的概念并不真实存在它仅仅描述的是一组约定或规范，通过这组现范定义了程序中(尤其是多线程)各人变量的读写访问方式并决定一个线程对共享变量的写入何时以及如何变成对另一个线程可见，关建技术点都是围绕多线程的原子性、可见性和有序性展开的。</h4><h4 id="原则"><a href="#原则" class="headerlink" title="原则:"></a>原则:</h4><h5 id="JMM的关键技术点都是围绕多线程的原子性、可见性和有序性展开的"><a href="#JMM的关键技术点都是围绕多线程的原子性、可见性和有序性展开的" class="headerlink" title="JMM的关键技术点都是围绕多线程的原子性、可见性和有序性展开的"></a>JMM的关键技术点都是围绕多线程的原子性、可见性和有序性展开的</h5><h4 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛?"></a>能干嘛?</h4><h4 id="通过JMM来实现线程和主内存之间的抽象关系。屏蔽各个硬件平台和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。"><a href="#通过JMM来实现线程和主内存之间的抽象关系。屏蔽各个硬件平台和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。" class="headerlink" title="通过JMM来实现线程和主内存之间的抽象关系。屏蔽各个硬件平台和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。"></a>通过JMM来实现线程和主内存之间的抽象关系。屏蔽各个硬件平台和操作系统的内存访问差异以实现让Java程序在各种平台下都能达到一致的内存访问效果。</h4><h5 id="考点-JMM-的三大特性是什么请对这三大特性-做一个说明吧"><a href="#考点-JMM-的三大特性是什么请对这三大特性-做一个说明吧" class="headerlink" title="考点==JMM 的三大特性是什么请对这三大特性 做一个说明吧=="></a>考点==JMM 的三大特性是什么请对这三大特性 做一个说明吧==</h5><h6 id="1-可见性-：当一个线程更改了共享变量的值，其他线程能否立即知道共享变量发生了变更。JMM规定了共享变量存储在主内存中。系统主内存中共享变量被写入的时机不确定，多线程的环境下容易产生脏读。每个线程都有自己的工作内存，工作内存中保存了该线程使用变量的主内存副本拷贝，每个线程只能操作自己工作内存中的变量，不能直接读取主内存中的变量。不同线程不能直接访问对方工作内存中的变量，线程变量值的传递需要通过主内存来完成"><a href="#1-可见性-：当一个线程更改了共享变量的值，其他线程能否立即知道共享变量发生了变更。JMM规定了共享变量存储在主内存中。系统主内存中共享变量被写入的时机不确定，多线程的环境下容易产生脏读。每个线程都有自己的工作内存，工作内存中保存了该线程使用变量的主内存副本拷贝，每个线程只能操作自己工作内存中的变量，不能直接读取主内存中的变量。不同线程不能直接访问对方工作内存中的变量，线程变量值的传递需要通过主内存来完成" class="headerlink" title="1. ==可见性 ：当一个线程更改了共享变量的值，其他线程能否立即知道共享变量发生了变更。JMM规定了共享变量存储在主内存中。系统主内存中共享变量被写入的时机不确定，多线程的环境下容易产生脏读。每个线程都有自己的工作内存，工作内存中保存了该线程使用变量的主内存副本拷贝，每个线程只能操作自己工作内存中的变量，不能直接读取主内存中的变量。不同线程不能直接访问对方工作内存中的变量，线程变量值的传递需要通过主内存来完成=="></a>1. ==可见性 ：当一个线程更改了共享变量的值，其他线程能否立即知道共享变量发生了变更。JMM规定了共享变量存储在主内存中。系统主内存中共享变量被写入的时机不确定，多线程的环境下容易产生脏读。每个线程都有自己的工作内存，工作内存中保存了该线程使用变量的主内存副本拷贝，每个线程只能操作自己工作内存中的变量，不能直接读取主内存中的变量。不同线程不能直接访问对方工作内存中的变量，线程变量值的传递需要通过主内存来完成==</h6><h6 id="2-原子性-：指同一个操作不能被打断，多线程的环境下，操作不能被其他线程干扰"><a href="#2-原子性-：指同一个操作不能被打断，多线程的环境下，操作不能被其他线程干扰" class="headerlink" title="2. ==原子性 ：指同一个操作不能被打断，多线程的环境下，操作不能被其他线程干扰=="></a>2. ==原子性 ：指同一个操作不能被打断，多线程的环境下，操作不能被其他线程干扰==</h6><h6 id="3-有序性-：JAVA规范规定的JVM线程内部维持的顺序化语序，如果代码执行的最终结果与顺序执行的结果一致，那么指令执行的顺序与代码执行的顺序不一致-即指令重新排序"><a href="#3-有序性-：JAVA规范规定的JVM线程内部维持的顺序化语序，如果代码执行的最终结果与顺序执行的结果一致，那么指令执行的顺序与代码执行的顺序不一致-即指令重新排序" class="headerlink" title="3. ==有序性 ：JAVA规范规定的JVM线程内部维持的顺序化语序，如果代码执行的最终结果与顺序执行的结果一致，那么指令执行的顺序与代码执行的顺序不一致 即指令重新排序=="></a>3. ==有序性 ：JAVA规范规定的JVM线程内部维持的顺序化语序，如果代码执行的最终结果与顺序执行的结果一致，那么指令执行的顺序与代码执行的顺序不一致 即指令重新排序==</h6><h6 id="优点-JVM-根据处理器特性对机器指令重排-使机器指令更符合CPU的执行顺序-，最大限度的发挥了机器性能"><a href="#优点-JVM-根据处理器特性对机器指令重排-使机器指令更符合CPU的执行顺序-，最大限度的发挥了机器性能" class="headerlink" title="==优点: JVM 根据处理器特性对机器指令重排 使机器指令更符合CPU的执行顺序 ，最大限度的发挥了机器性能=="></a>==优点: JVM 根据处理器特性对机器指令重排 使机器指令更符合CPU的执行顺序 ，最大限度的发挥了机器性能==</h6><h6 id="缺点：指令重排可以保证串行语义的一致，但不能保证多线程语义也一致"><a href="#缺点：指令重排可以保证串行语义的一致，但不能保证多线程语义也一致" class="headerlink" title="==缺点：指令重排可以保证串行语义的一致，但不能保证多线程语义也一致=="></a>==缺点：指令重排可以保证串行语义的一致，但不能保证多线程语义也一致==</h6><p> <img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/jMM%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="JMM原理图"></p>
<h4 id="考点happens-before总原则理解"><a href="#考点happens-before总原则理解" class="headerlink" title="==考点happens-before总原则理解=="></a>==考点happens-before总原则理解==</h4><h6 id="如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见而且第一个操作的执行顺序排在第二个操作之前。"><a href="#如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见而且第一个操作的执行顺序排在第二个操作之前。" class="headerlink" title="如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见而且第一个操作的执行顺序排在第二个操作之前。"></a>如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见而且第一个操作的执行顺序排在第二个操作之前。</h6><h6 id="两个操作之间存在happens-before关系，并不意味着一定要按照happens-before原则制定的顺序来执行如果重排序之后的执行结果与按照happens-before关系来执行的结果一致，那么这种重排序并不非法。"><a href="#两个操作之间存在happens-before关系，并不意味着一定要按照happens-before原则制定的顺序来执行如果重排序之后的执行结果与按照happens-before关系来执行的结果一致，那么这种重排序并不非法。" class="headerlink" title="两个操作之间存在happens-before关系，并不意味着一定要按照happens-before原则制定的顺序来执行如果重排序之后的执行结果与按照happens-before关系来执行的结果一致，那么这种重排序并不非法。"></a>两个操作之间存在happens-before关系，并不意味着一定要按照happens-before原则制定的顺序来执行如果重排序之后的执行结果与按照happens-before关系来执行的结果一致，那么这种重排序并不非法。</h6><h5 id="happens-before-原则具体版"><a href="#happens-before-原则具体版" class="headerlink" title="happens-before 原则具体版"></a>happens-before 原则具体版</h5><ul>
<li>.1次序规则: 一个线程内，按照代码顺序，写在前面的操作先行发生于写在后面的操作; 前一个操作的结果可以被后续的操作获取<br>讲直白点就是前面一个操作把变量X赋值为1，那后面一个操作肯定能知道X已经变成了1</li>
<li>2.锁定规则: 个unLock操作先行发生于后面((这里的“后面”是指时间上的先后))对同一个锁的lock操作;</li>
<li>3.volatile变量规则:对一个volatile变量的写操作先行发生于后面对这个变量的读操作，前面的写对后面的读是可见的，这里的“后面”同样是指时间上的先后</li>
<li>4.传递规则:如果操作A先行发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</li>
<li>5.线程启动规则(Thread Start Rule):Thread对象的start()方法先行发生于此线程的每一个动作</li>
<li>6.线程中断规则(Thread Interruption Rule): 对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生;可以通过Thread.interrupted()检测到是否发生中断也就是说你要先调用interrupt()方法设置过中断标志位，我才能检测到中断发生</li>
<li>7.线程终止规则(Thread Termination Rule): 线程中的所有操作都先行发生于对此线程的终止检测，我们可以通过isAlive()等手段检测线程是否已经终止执行</li>
<li>8.对象终结规则(Finalizer Rule): 对象没有完成初始化之前，是不能调用finalized0)方法的</li>
</ul>
<h3 id="volatile-和-JMM"><a href="#volatile-和-JMM" class="headerlink" title="volatile  和  JMM"></a>volatile  和  JMM</h3><h5 id="考点被volatile修饰的变量有什么特点-：可见性-有序性"><a href="#考点被volatile修饰的变量有什么特点-：可见性-有序性" class="headerlink" title="==考点被volatile修饰的变量有什么特点 ：可见性 有序性=="></a>==考点被volatile修饰的变量有什么特点 ：可见性 有序性==</h5><h5 id="volatile的内存语义（作用）：当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值立即刷新回主内存中。当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，重新回到主内存中读取最新共享变所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取"><a href="#volatile的内存语义（作用）：当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值立即刷新回主内存中。当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，重新回到主内存中读取最新共享变所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取" class="headerlink" title="volatile的内存语义（作用）：当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值立即刷新回主内存中。当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，重新回到主内存中读取最新共享变所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取"></a>volatile的内存语义（作用）：当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值立即刷新回主内存中。当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，重新回到主内存中读取最新共享变所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取</h5><h5 id="考点的通过什么方式保证可以见性和有序性：是通过内存屏障"><a href="#考点的通过什么方式保证可以见性和有序性：是通过内存屏障" class="headerlink" title="==考点的通过什么方式保证可以见性和有序性：是通过内存屏障=="></a>==考点的通过什么方式保证可以见性和有序性：是通过内存屏障==</h5><h6 id=""><a href="#" class="headerlink" title=""></a></h6><h5 id="说说内存屏障原理（-重点-）"><a href="#说说内存屏障原理（-重点-）" class="headerlink" title="说说内存屏障原理（==重点==）"></a>说说内存屏障原理（==重点==）</h5><h6 id="再说内存屏障之前，先看看对于有序性的理解"><a href="#再说内存屏障之前，先看看对于有序性的理解" class="headerlink" title="再说内存屏障之前，先看看对于有序性的理解"></a>再说内存屏障之前，先看看对于有序性的理解</h6><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">有序(禁重排)
重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段，有时候会改变程序语句的先后顺序不存在数据依赖关系，可以重排序;
存在数据依赖关系，禁止重排序但重排后的指令绝对不能改变原有的串行语义!这点在并发设计中必须要重点考虑!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h6 id="内存屏障的分类"><a href="#内存屏障的分类" class="headerlink" title="内存屏障的分类"></a>内存屏障的分类</h6><ul>
<li><p>粗分两种：读屏障 （在读指令之前插入读屏障，让工作内存或CPU高速缓存当中的缓存数据失效，重新回到主内存中获取最新数据）和写的屏障（在写指令之后插入写屏障，强制把写缓冲区的数据刷回到主内存中）</p>
</li>
<li><p>细分有四种：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>屏障类型</th>
<th>指令示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LoadLoad</td>
<td>Load1;LoadLoad;Load2</td>
<td>保证load1的读取操作在load2及后续读取操作之前执行</td>
</tr>
<tr>
<td>StoreStore</td>
<td>Store1; StoreStore; Store2</td>
<td>在store2及其后的写操作执行前，保证store1的写操作已刷新到主内存</td>
</tr>
<tr>
<td>LoadStore</td>
<td>Load1: LoadStore: Store2</td>
<td>在stroe2及其后的写操作执行前，保证load1的读操作已读取结束</td>
</tr>
<tr>
<td>StoreLoad</td>
<td>Store1: Storeload: Load2</td>
<td>保证store1的写操作已刷新到主内存之后，load2及其后的读操作才能执行</td>
</tr>
</tbody></table>
<h4 id="Happens-before之volatile-的规则-策略"><a href="#Happens-before之volatile-的规则-策略" class="headerlink" title="Happens-before之volatile 的规则 策略"></a>Happens-before之volatile 的规则 策略</h4><table>
<thead>
<tr>
<th>第一个操作</th>
<th>第二个操作: 普通读写</th>
<th>第二个操作: volatile读</th>
<th>第二个操作: volatile读</th>
</tr>
</thead>
<tbody><tr>
<td>普通读写</td>
<td>普通读写</td>
<td>普通读写</td>
<td>不可以重排</td>
</tr>
<tr>
<td>volatile读</td>
<td>不可以重排</td>
<td>不可以重排</td>
<td>不可以重排</td>
</tr>
<tr>
<td>volatile写</td>
<td>可以重排</td>
<td>不可以重排</td>
<td>不可以重排</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="策略的记忆口诀"><a href="#策略的记忆口诀" class="headerlink" title="策略的记忆口诀"></a>策略的记忆口诀</h6><ul>
<li><p>当第一个操作为volatle读时，不论第二个操作是什么，都不能重排序。这个操作保证了volatle读之后的操作不会被重排到volatile读之前。</p>
</li>
<li><p>当第二个操作为volatile写时，不论第一个操作是什么，都不能重排序。这个操作保证了volatile写之前的操作不会被重排到volatile写之后。</p>
</li>
<li><p>当第一个操作为volatile写时，第二个操作为volatile读时，不能重排。</p>
</li>
</ul>
<h6 id="读屏障的示意图"><a href="#读屏障的示意图" class="headerlink" title="读屏障的示意图"></a>读屏障的示意图</h6><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="内存屏障的理解图"></p>
<h6 id="写屏障的示意图"><a href="#写屏障的示意图" class="headerlink" title="写屏障的示意图"></a>写屏障的示意图</h6><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%86%99%E5%B1%8F%E9%9A%9C%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="写屏障的示意图"></p>
<h5 id="volatie-变量写过程的"><a href="#volatie-变量写过程的" class="headerlink" title="volatie 变量写过程的"></a>volatie 变量写过程的</h5><ul>
<li><p>read: 作用于主内存，将变量的值从主内存传输到工作内存，主内存到工作内存</p>
</li>
<li><p>load: 作用于工作内存，将read从主内存传输的变量值放入工作内存变量副本中，即数据加载</p>
</li>
<li><p>use: 作用于工作内存，将工作内存变量副本的值传递给执行引擎，每当JVM遇到需要该变量的字节码指令时会执行该操作</p>
</li>
<li><p>assign: 作用于工作内存，将从执行引警接收到的值赋值给工作内存变量，每当JVM遇到一个给变量赋值字节码指令时会执行该操作</p>
</li>
<li><p>store: 作用于工作内存，将赋值完毕的工作变量的值写回给主内存</p>
</li>
<li><p>write:作用于主内存，将store传输过来的变量值赋值给主内存中的变量</p>
</li>
<li><p>==由于上述6条只能保证单条指令的原子性，针对多条指令的组合性原子保证，没有大面积加锁，所以，JVM提供了另外两个原子指令==</p>
<ul>
<li><p>lock: 作用于主内存，将一个变量标记为一个线程独占的状态，只是写时候加锁，就只是锁了写变量的过程。</p>
</li>
<li><p>unlock: 作用于主内存，把一个处于锁定状态的变量释放，然后才能被其他线程占用</p>
</li>
</ul>
</li>
</ul>
<h5 id="考点volatile-的使用场景"><a href="#考点volatile-的使用场景" class="headerlink" title="==考点volatile 的使用场景=="></a>==考点volatile 的使用场景==</h5><ul>
<li><p>单一赋值可以，but含复合运算赋值不可以(i++之类)</p>
</li>
<li><p>状态标志，判断业务是否结束  （变量可以用volatile 修饰）</p>
</li>
<li><p>开销较低的读，写锁策略  （再写使用sychornized 修饰  读的变量的使用volatile 修饰）</p>
</li>
<li><p>AtomicIntegerFieldUpdater，AtomicLongFieldUpdater，AtomicReferenceFieldUpdater 更新的对象属性必须使用 public volatile 修饰符</p>
</li>
<li><p>DCL双端锁的发布 （单例模式的中双重检查）</p>
</li>
</ul>
  <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>itdachang</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> singleton<span class="token punctuation">;</span>
    <span class="token comment">//私育化构造方法</span>
<span class="token keyword">private</span> <span class="token class-name">SafeDoubleChecksingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//双重锁没计</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span>  <span class="token class-name">SafeDoubleCheckSingleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> nu11<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1.多线程并发创建对象时，会通过加锁保证只有一个线程能创建对象</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> nu11<span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token comment">//隐患，多线程环境下，由于重排序，该对象可能还未完成初始化就被其他线程读职</span>
                singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//2.对象创建完毕，执行getInstance()特不需要获职锁，直接返回创建对象</span>
    <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="面试volatile-的时候，从这个点法上面区表述"><a href="#面试volatile-的时候，从这个点法上面区表述" class="headerlink" title="面试volatile 的时候，从这个点法上面区表述"></a>面试volatile 的时候，从这个点法上面区表述</h5><table>
<thead>
<tr>
<th>volatile关键字保证可见性:</th>
<th>对一个被volatile关键字修改的变量</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>写操作的话，这个变量的最新值会立即刷新回到主内存中</td>
</tr>
<tr>
<td></td>
<td>读操作的话，总是能够读取到这个变量的最新值，也就是这个变量最后被修改的值</td>
</tr>
<tr>
<td></td>
<td>当某个线程收到通知，去读取volatile修饰的变量的值的时候，线程私有工作内存的数据失效，需要重新回到主内存中去读取最新的数据。</td>
</tr>
<tr>
<td>没有原子性</td>
<td>：结合线程当操作复合运算++ i 的问题上，他们的步骤不是原子性，被其他线程修改</td>
</tr>
<tr>
<td>禁止重排序（有序性）</td>
<td></td>
</tr>
<tr>
<td>==凭啥就给我们volatile就会加内存屏障==</td>
<td>底层看volatile 修饰就添加 ACC_VOLATILE  程序就会按照这个加内存屏障</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">compare and swap的缩写，中文翻译成比较并交换,实现并发算法时常用到的一种技术。
它包含三个操作数一一内存位置、预期原值及更新值。
执行CAS操作的时候，将内存位置的值与预期原值比较:如果相匹配，那么处理器会自动将该位置值更新为新值如果不匹配，处理器不做任何操作，多个线程同时执行CAS操作只有一个会成功。
CAS有3个操作数，位置内存值V，旧的预期值A，要修改的更新值B当且仅当旧的预期值A和内存值V相同时，将内存值V修改为B，否则什么都不做或重来当它重来重试的这种行为成为----自旋! !<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/CAS%E5%9B%BE%E4%BE%8B%E8%AF%B4%E6%98%8E.png" alt="CAS的图例"></p>
<h5 id="认识CAS-要对底层的unsafa-核心类的了解"><a href="#认识CAS-要对底层的unsafa-核心类的了解" class="headerlink" title="认识CAS 要对底层的unsafa 核心类的了解"></a>认识CAS 要对底层的unsafa 核心类的了解</h5><h6 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h6><p>是CAS的核心类，由于Java方法无法直接访问底层系统，需要通过本地(native) 方法来访问，Unsafe相当于一个后门，基于该类可以直接操作特定内存的数据。Unsafe类存在于sun.misc包中，其内部方法操作可以像C的指针一样直接操作内存，因为Java中CAS操作的执行依赖于Unsafe类的方法。</p>
<p><strong><em>注意Unsafe类中的所有方法都是native修饰的，也就是说Unsafe类中的法都直接调用操作系统底层资源执行相应作务</em></strong></p>
<p><strong>CAS并发原语体现在JAVA语言中就是sun.misc.Unsafe类中的核心方法。==调用UnSafe类中的CAS方法，JVM会帮我们实现出CAS汇编指令。这是一种完全依赖于硬件的功能，通过它实现了原子操作。再次强调，由于CAS是一种系统原语，原语属于操作系统用语范畴，是由若干条指令组成的，用于完成某个功能的一个过程，并且原语的执行必须是连续的，在执行过程中不允许被中断，也就是说CAS是一条CPU的原子指令，不会造成所谓的数据不一致问题==。</strong></p>
<h6 id="JUC-下的并发包的原子类"><a href="#JUC-下的并发包的原子类" class="headerlink" title="JUC 下的并发包的原子类"></a>JUC 下的并发包的原子类</h6><h5 id="volatile-解决多线程内存不可见问题对于一写多读，是可以解决变量同步问题，但是如果多写，同样无法解决线程安全问题。"><a href="#volatile-解决多线程内存不可见问题对于一写多读，是可以解决变量同步问题，但是如果多写，同样无法解决线程安全问题。" class="headerlink" title="volatile 解决多线程内存不可见问题对于一写多读，是可以解决变量同步问题，但是如果多写，同样无法解决线程安全问题。"></a>volatile 解决多线程内存不可见问题对于一写多读，是可以解决变量同步问题，但是如果多写，同样无法解决线程安全问题。</h5><h5 id="说明-如果是-count-操作，使用如下类实现"><a href="#说明-如果是-count-操作，使用如下类实现" class="headerlink" title="说明: 如果是 count+ +操作，使用如下类实现:"></a>说明: 如果是 count+ +操作，使用如下类实现:</h5><p>AtomicInteger count = new AtomicInteger();<br>count.addAndGet(1):</p>
<h5 id="如果是JDK8，-推荐使用-LongAdder-对象，比-AtomicLong-性能更好-减少乐观锁的重试次数"><a href="#如果是JDK8，-推荐使用-LongAdder-对象，比-AtomicLong-性能更好-减少乐观锁的重试次数" class="headerlink" title="如果是JDK8，==推荐使用 LongAdder 对象，比 AtomicLong 性能更好==(减少乐观锁的重试次数)"></a>如果是JDK8，==推荐使用 LongAdder 对象，比 AtomicLong 性能更好==(减少乐观锁的重试次数)</h5><h6 id="在LongAdder-和AtomicLong-它们在并发量低的时候，性能差不了多少。但在高并发的时候，LongAdder的基本思路就是分散热点，将value值分散到一个Ce数组中，不同线程会命中到数组的不同槽中，各个线程只对自己槽中的那个值进行CAS操作，这样热点就被分散了，冲突的概率就小很多。如果要获取真正的long值，只要将各个槽中的变量值累加返回。（内部一个base-变量，一个-cell-数组-：base-是在低并发情况下，做CAS累加。如果一直自旋失败的话，那么就直接-创建Cell数组-来分担压力。每个cell的元素都存放不同不同线程的累加。最终把各个cell-数组元素的里面的值和base-相加。效率会一个base-处理数据快）"><a href="#在LongAdder-和AtomicLong-它们在并发量低的时候，性能差不了多少。但在高并发的时候，LongAdder的基本思路就是分散热点，将value值分散到一个Ce数组中，不同线程会命中到数组的不同槽中，各个线程只对自己槽中的那个值进行CAS操作，这样热点就被分散了，冲突的概率就小很多。如果要获取真正的long值，只要将各个槽中的变量值累加返回。（内部一个base-变量，一个-cell-数组-：base-是在低并发情况下，做CAS累加。如果一直自旋失败的话，那么就直接-创建Cell数组-来分担压力。每个cell的元素都存放不同不同线程的累加。最终把各个cell-数组元素的里面的值和base-相加。效率会一个base-处理数据快）" class="headerlink" title="在LongAdder 和AtomicLong  它们在并发量低的时候，性能差不了多少。但在高并发的时候，LongAdder的基本思路就是分散热点，将value值分散到一个Ce数组中，不同线程会命中到数组的不同槽中，各个线程只对自己槽中的那个值进行CAS操作，这样热点就被分散了，冲突的概率就小很多。如果要获取真正的long值，只要将各个槽中的变量值累加返回。（内部一个base  变量，一个 cell[] 数组   ：base 是在低并发情况下，做CAS累加。如果一直自旋失败的话，那么就直接 创建Cell数组 来分担压力。每个cell的元素都存放不同不同线程的累加。最终把各个cell 数组元素的里面的值和base 相加。效率会一个base 处理数据快）"></a>在LongAdder 和AtomicLong  它们在并发量低的时候，性能差不了多少。但在高并发的时候，LongAdder的基本思路就是分散热点，将value值分散到一个Ce数组中，不同线程会命中到数组的不同槽中，各个线程只对自己槽中的那个值进行CAS操作，这样热点就被分散了，冲突的概率就小很多。如果要获取真正的long值，只要将各个槽中的变量值累加返回。（内部一个base  变量，一个 cell[] 数组   ：base 是在低并发情况下，做CAS累加。如果一直自旋失败的话，那么就直接 创建Cell数组 来分担压力。每个cell的元素都存放不同不同线程的累加。最终把各个cell 数组元素的里面的值和base 相加。效率会一个base 处理数据快）</h6><h5 id="说说AtomicStampedReference-和-AtomicMarkableReference-的区别"><a href="#说说AtomicStampedReference-和-AtomicMarkableReference-的区别" class="headerlink" title="说说AtomicStampedReference  和 AtomicMarkableReference 的区别"></a>说说AtomicStampedReference  和 AtomicMarkableReference 的区别</h5><ul>
<li><p>AtomicStampedReference  解决修改状态戳原 修改多次的原子更新</p>
</li>
<li><p>AtomicMarkableReference 解决一次的状态的修改的原子更新</p>
</li>
</ul>
<h3 id="TheadLocadl"><a href="#TheadLocadl" class="headerlink" title="TheadLocadl"></a>TheadLocadl</h3><h4 id="定义："><a href="#定义：" class="headerlink" title="定义："></a>定义：</h4><h5 id="ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候-通过其get或set方法-都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态-例如，用户ID或事务1D-与线程关联起来。"><a href="#ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候-通过其get或set方法-都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态-例如，用户ID或事务1D-与线程关联起来。" class="headerlink" title="ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候(通过其get或set方法)都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态(例如，用户ID或事务1D)与线程关联起来。"></a>ThreadLocal提供线程局部变量。这些变量与正常的变量不同，因为每一个线程在访问ThreadLocal实例的时候(通过其get或set方法)都有自己的、独立初始化的变量副本。ThreadLocal实例通常是类中的私有静态字段，使用它的目的是希望将状态(例如，用户ID或事务1D)与线程关联起来。</h5><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><h5 id="实现每一个线程都有自己专属的本地变量副本-自己用自己的变量不麻烦别人，不和其他人共享，人人有份，人各一份-主要解决了让每个线程绑定自己的值，通过使用get0和set方法，获取默认值或将其值更改为当前线程所存的副本的值从而避免了线程安全问"><a href="#实现每一个线程都有自己专属的本地变量副本-自己用自己的变量不麻烦别人，不和其他人共享，人人有份，人各一份-主要解决了让每个线程绑定自己的值，通过使用get0和set方法，获取默认值或将其值更改为当前线程所存的副本的值从而避免了线程安全问" class="headerlink" title="实现每一个线程都有自己专属的本地变量副本(自己用自己的变量不麻烦别人，不和其他人共享，人人有份，人各一份), 主要解决了让每个线程绑定自己的值，通过使用get0和set方法，获取默认值或将其值更改为当前线程所存的副本的值从而避免了线程安全问"></a>实现每一个线程都有自己专属的本地变量副本(自己用自己的变量不麻烦别人，不和其他人共享，人人有份，人各一份), 主要解决了让每个线程绑定自己的值，通过使用get0和set方法，获取默认值或将其值更改为当前线程所存的副本的值从而避免了线程安全问</h5><p>题，比如我们之前讲解的8锁案例，资源类是使用同一部手机，多个线程抢夺同一部手机使用，假如人手一份是不是天下太平??</p>
<h5 id="ThreadLocal考点"><a href="#ThreadLocal考点" class="headerlink" title="==ThreadLocal考点=="></a>==ThreadLocal考点==</h5><h6 id="ThreadLocal中ThreadLocalMap的数据结构和关系"><a href="#ThreadLocal中ThreadLocalMap的数据结构和关系" class="headerlink" title="ThreadLocal中ThreadLocalMap的数据结构和关系?"></a>ThreadLocal中ThreadLocalMap的数据结构和关系?</h6><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Thread 里面的包含一个ThreadLocal 引用  而ThreadLocal 里面有一个静态内部类TheadLocadlMap。 ThreadLocal为key 存放在value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h6 id="ThreadLocal的key是弱引用，这是为什么"><a href="#ThreadLocal的key是弱引用，这是为什么" class="headerlink" title="ThreadLocal的key是弱引用，这是为什么?"></a>ThreadLocal的key是弱引用，这是为什么?</h6><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">弱引用相较于前面的强引用和软引用的的话，jvm 更会主动去回收ThreadLocalMap 的key 这样的不会到导致内存泄漏。
当function1方法执行完毕后，栈销毁强引用 tl 也就没有了。但此时线程的ThreadLocalMap里某个entry的key引用还指向这个对象若这个key引用是强引用，就会导致key指向的ThreadLocal对象及v指向的对象不能被gc回收，造成内存泄漏;若这个key引用是弱引用就大概率会减少内存泄漏的问题(还有一个key为nul的雷，第2个坑后面讲)。使用弱引用（合理），就可以使ThreadLocal对象在方法执行完毕后顺利被回收且Entry的key引用指向为null.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>​    </p>
<h6 id="ThreadLocal内存泄露问题你知道吗-threadLocal中最后为什么要加remove方法"><a href="#ThreadLocal内存泄露问题你知道吗-threadLocal中最后为什么要加remove方法" class="headerlink" title="ThreadLocal内存泄露问题你知道吗? threadLocal中最后为什么要加remove方法?"></a>ThreadLocal内存泄露问题你知道吗? threadLocal中最后为什么要加remove方法?</h6><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">ThreadLocal自定义的变量用完需要remove 掉  ，减少线程的负担。特别线程池的复用导致线程内存泄漏 使用中 try -finally块回收。
使用弱引用的不能避免百分百，因为当ThreadLocal 的被回收之后，线程里面还有当key 为null 的value。而这些value一直ThraeadLocalmap强引用，这样的jvm 不能回收。如果在线程池复用的导内存泄漏。当使用 set 方法和get 以及 remove 方法 .都会先去判断key 是否为null ,如果是的就会把 key为null的value 给回收。避免内存泄漏和复用导致bug 手动remove　　有必要的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="对象内存布局之对象头"><a href="#对象内存布局之对象头" class="headerlink" title="对象内存布局之对象头"></a>对象内存布局之对象头</h3><h4 id="对象头的构成"><a href="#对象头的构成" class="headerlink" title="对象头的构成"></a>对象头的构成</h4><h5 id="运行时元数据-Mark-Word"><a href="#运行时元数据-Mark-Word" class="headerlink" title="运行时元数据 (Mark Word)"></a>运行时元数据 (Mark Word)</h5><h6 id="哈希值-HashCode"><a href="#哈希值-HashCode" class="headerlink" title="哈希值 (HashCode)"></a>哈希值 (HashCode)</h6><h6 id="GC分代年龄"><a href="#GC分代年龄" class="headerlink" title="GC分代年龄"></a>GC分代年龄</h6><h6 id="锁状态标志"><a href="#锁状态标志" class="headerlink" title="锁状态标志"></a>锁状态标志</h6><h6 id="线程持有的锁"><a href="#线程持有的锁" class="headerlink" title="线程持有的锁"></a>线程持有的锁</h6><h6 id="偏向线程ID"><a href="#偏向线程ID" class="headerlink" title="偏向线程ID"></a>偏向线程ID</h6><h6 id="偏向时间戳"><a href="#偏向时间戳" class="headerlink" title="偏向时间戳"></a>偏向时间戳</h6><h5 id="类型指针一一指向类元数据InstanceClass，确定该对象所属的类型"><a href="#类型指针一一指向类元数据InstanceClass，确定该对象所属的类型" class="headerlink" title="类型指针一一指向类元数据InstanceClass，确定该对象所属的类型"></a>类型指针一一指向类元数据InstanceClass，确定该对象所属的类型</h5><h4 id="实例数据-Instance-Data-它是对急真正存储的有效信息，包括程序代码中定义的各种类型的字段-包括从父类继承下来的和本身拥有的字段"><a href="#实例数据-Instance-Data-它是对急真正存储的有效信息，包括程序代码中定义的各种类型的字段-包括从父类继承下来的和本身拥有的字段" class="headerlink" title="实例数据 (Instance Data) :它是对急真正存储的有效信息，包括程序代码中定义的各种类型的字段(包括从父类继承下来的和本身拥有的字段)"></a>实例数据 (Instance Data) :它是对急真正存储的有效信息，包括程序代码中定义的各种类型的字段(包括从父类继承下来的和本身拥有的字段)</h4><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%A4%B4.png" alt="对象头布局"></p>
<h3 id="锁的升级"><a href="#锁的升级" class="headerlink" title="锁的升级"></a>锁的升级</h3><h4 id="sychcornized锁-由对象头中的Mark-Word根据锁标志位的不同而被复用及锁升级策略"><a href="#sychcornized锁-由对象头中的Mark-Word根据锁标志位的不同而被复用及锁升级策略" class="headerlink" title="sychcornized锁:由对象头中的Mark Word根据锁标志位的不同而被复用及锁升级策略"></a>sychcornized锁:由对象头中的Mark Word根据锁标志位的不同而被复用及锁升级策略</h4><h4 id="锁升级的背景"><a href="#锁升级的背景" class="headerlink" title="锁升级的背景"></a>锁升级的背景</h4><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">java的线程是映射到操作系统原生线程之上的，如果要阳塞或唤醒一个线程就需要换作系统介入，需要在户态与核心态之间切换，这种切换会消料大量的系统资源，因为用户态与内核态都有各自专用的内存空间，专用的寄存器等，用户态切换至内核态需要传递给许多变量、参数给内核，内核也需要保护好用户态在切换时的一些寄存器值、变量等，以便内核态调用结束后切换回用户态继续工作。在Java早期版本中，synchronized属于重量级锁，效率低下，因为监视器锁 (monitor)是依赖于底层的操作系统的Mutex Lock(系统互斥量)来实现的，挂起线程和恢复线程都需要转入内核态去完成，阳寒或唤醒一个Jaa线程需要换作系统切换CPU状态来完成，这种状态切换需要耗费处理器时间，如果同步代码块中内容过于简单，这种切换的时间可能比用户代码执行的时间还长”，时间成本相对较高，这也是为什么早期的synchronized效率低的原因Java 6之后，为了减少获得锁和释放锁所带来的性能消耗，引入了轻量级锁和偏向锁.

Monitor可以理解为一种同步工具
，也可理解为一种同步机制，常常被描述为一价Java对象。Java对象是天生的Monitor，每一个Java对象都有成为Monitor的潜质，因为在Jva的设计中，每一个Java对象自打娘胎里出来就带了一把看不见的锁，它叫做内部锁或者Monitor锁。
Monitor的本质是依赖于底层操作系统的Mutex Lock实现，操作系统实现线程之间的切换需要从用户态到内核态的转换，成本非常高。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="锁的指向"><a href="#锁的指向" class="headerlink" title="锁的指向"></a>锁的指向</h4><h5 id="偏向锁-MarkWord存储的是偏向的线程ID"><a href="#偏向锁-MarkWord存储的是偏向的线程ID" class="headerlink" title="偏向锁: MarkWord存储的是偏向的线程ID;"></a>偏向锁: MarkWord存储的是偏向的线程ID;</h5><h5 id="轻量锁-MarkWord存储的是指向线程栈中Lock-Record的指针"><a href="#轻量锁-MarkWord存储的是指向线程栈中Lock-Record的指针" class="headerlink" title="轻量锁: MarkWord存储的是指向线程栈中Lock Record的指针;"></a>轻量锁: MarkWord存储的是指向线程栈中Lock Record的指针;</h5><h5 id="重量锁-MarkWord存储的是指向堆中的monitor对象的指针"><a href="#重量锁-MarkWord存储的是指向堆中的monitor对象的指针" class="headerlink" title="重量锁: MarkWord存储的是指向堆中的monitor对象的指针;"></a>重量锁: MarkWord存储的是指向堆中的monitor对象的指针;</h5><h4 id="偏向锁的撤销"><a href="#偏向锁的撤销" class="headerlink" title="偏向锁的撤销"></a>偏向锁的撤销</h4><h5 id="当有另外线程逐步来竞争锁的时候，就不能再使用偏向锁了，要升级为轻量级锁"><a href="#当有另外线程逐步来竞争锁的时候，就不能再使用偏向锁了，要升级为轻量级锁" class="headerlink" title="当有另外线程逐步来竞争锁的时候，就不能再使用偏向锁了，要升级为轻量级锁"></a>当有另外线程逐步来竞争锁的时候，就不能再使用偏向锁了，要升级为轻量级锁</h5><h5 id="竞争线程尝试CAS更新对象头失败，会等待到全局安全点《此时不会执行任何代码-撤销偏向锁。"><a href="#竞争线程尝试CAS更新对象头失败，会等待到全局安全点《此时不会执行任何代码-撤销偏向锁。" class="headerlink" title="竞争线程尝试CAS更新对象头失败，会等待到全局安全点《此时不会执行任何代码) 撤销偏向锁。"></a>竞争线程尝试CAS更新对象头失败，会等待到全局安全点《此时不会执行任何代码) 撤销偏向锁。</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">偏向锁的撤销()
偏向锁使用一种等到竞争出现才释放锁的机制，只有当其他线程竞争锁时，持有偏向锁的原来线程才会被撤销撤销需要等待全局安全点(该时间点上没有字节码正在执行)，同时检查持有偏向锁的线程是否还在执行:
1第一个线程正在执行synchronized方法(处于同步块)，它还没有执行完，其它线程来抢夺，该偏向锁会被取消掉并出现锁升级此时轻量级锁由原持有偏向锁的线程持有，继续执行其同步代码，而正在竞争的线程会进入自旋等待获得该轻量级锁。
2第一个线程执行完成synchronized方法(退出同步块)，则将对象头设置成无锁状态并撤销偏向锁，重新偏向。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="轻量锁-1"><a href="#轻量锁-1" class="headerlink" title="轻量锁"></a>轻量锁</h4><h5 id="轻量级锁的加锁"><a href="#轻量级锁的加锁" class="headerlink" title="轻量级锁的加锁"></a>轻量级锁的加锁</h5><h6 id="JVM会为每个线程在当前线程的龙中创律用千存储锁记录的空间，官方成为Displaced-Mark-wrd。若一个线程获得锁时发现是量级锁，会把锁的MarkWord复制到自己的Displaced-Mark-Word里面。然后线程尝试用CAS将锁的MarkWord替换为指向锁记录的针。如果成功，当前线程获得锁，如果失败，表示Mark-Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前程就尝试使用自旋来获取锁。"><a href="#JVM会为每个线程在当前线程的龙中创律用千存储锁记录的空间，官方成为Displaced-Mark-wrd。若一个线程获得锁时发现是量级锁，会把锁的MarkWord复制到自己的Displaced-Mark-Word里面。然后线程尝试用CAS将锁的MarkWord替换为指向锁记录的针。如果成功，当前线程获得锁，如果失败，表示Mark-Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前程就尝试使用自旋来获取锁。" class="headerlink" title="JVM会为每个线程在当前线程的龙中创律用千存储锁记录的空间，官方成为Displaced Mark wrd。若一个线程获得锁时发现是量级锁，会把锁的MarkWord复制到自己的Displaced Mark Word里面。然后线程尝试用CAS将锁的MarkWord替换为指向锁记录的针。如果成功，当前线程获得锁，如果失败，表示Mark Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前程就尝试使用自旋来获取锁。"></a>JVM会为每个线程在当前线程的龙中创律用千存储锁记录的空间，官方成为Displaced Mark wrd。若一个线程获得锁时发现是量级锁，会把锁的MarkWord复制到自己的Displaced Mark Word里面。然后线程尝试用CAS将锁的MarkWord替换为指向锁记录的针。如果成功，当前线程获得锁，如果失败，表示Mark Word已经被替换成了其他线程的锁记录，说明在与其它线程竞争锁，当前程就尝试使用自旋来获取锁。</h6><h6 id="自旋CAS-不断尝试去获取锁，能不升级就不往上捅，尽量不要阻塞"><a href="#自旋CAS-不断尝试去获取锁，能不升级就不往上捅，尽量不要阻塞" class="headerlink" title="自旋CAS:不断尝试去获取锁，能不升级就不往上捅，尽量不要阻塞"></a>自旋CAS:不断尝试去获取锁，能不升级就不往上捅，尽量不要阻塞</h6><h5 id="轻量级锁的释放"><a href="#轻量级锁的释放" class="headerlink" title="轻量级锁的释放"></a>轻量级锁的释放</h5><h6 id="在释放锁时，当前线程会使用CAS操作将Displaced-Mak-Word的内容复制回锁的Mark-Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为白旋多次导致轻量级锁升级成了重量级锁，那么CAS操作会失败，此时会释放锁并唤醒被阳的线程。"><a href="#在释放锁时，当前线程会使用CAS操作将Displaced-Mak-Word的内容复制回锁的Mark-Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为白旋多次导致轻量级锁升级成了重量级锁，那么CAS操作会失败，此时会释放锁并唤醒被阳的线程。" class="headerlink" title="在释放锁时，当前线程会使用CAS操作将Displaced Mak Word的内容复制回锁的Mark Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为白旋多次导致轻量级锁升级成了重量级锁，那么CAS操作会失败，此时会释放锁并唤醒被阳的线程。"></a>在释放锁时，当前线程会使用CAS操作将Displaced Mak Word的内容复制回锁的Mark Word里面。如果没有发生竞争，那么这个复制的操作会成功。如果有其他线程因为白旋多次导致轻量级锁升级成了重量级锁，那么CAS操作会失败，此时会释放锁并唤醒被阳的线程。</h6><h4 id="重量级锁-1"><a href="#重量级锁-1" class="headerlink" title="重量级锁"></a>重量级锁</h4><h5 id="重量级锁原理-1"><a href="#重量级锁原理-1" class="headerlink" title="重量级锁原理"></a>重量级锁原理</h5><h6 id="指向互斥量-重量级锁-的指针-1"><a href="#指向互斥量-重量级锁-的指针-1" class="headerlink" title="指向互斥量 (重量级锁)的指针"></a>指向互斥量 (重量级锁)的指针</h6><p>Java中synchronized的重量级锁，是基于进入和退出Monitor对象实现的。在编译时会将同步块的开始位置插入monitor enter指令，在结束位置插入monitor exit指令。<br>当线程执行到monitor enter指令时，会尝试获取对象所对应的Monitor所有权，如果获取到了，即获取到了锁，会在Monitor的owner中存放当前线程的id，这样它将处于锁定状态，除非退出同步块，否则其他线程无法获取到这个Monitor。</p>
<h4 id="锁升级的总结"><a href="#锁升级的总结" class="headerlink" title="锁升级的总结"></a>锁升级的总结</h4><ul>
<li>==在无锁状态下==，Mark Word中可以存储对象的identity hash code值。当对象的hashCode0)方法第一次被调用时，JVM会生成对应的dentity hash code值并将该值存储到Mark Word中。</li>
<li>==对干偏白锁==，在线程获取偏向锁时，会用Thread ID和epoch值覆盖identity hash code所在的位置。如果一个对象的hashCode0)方法已经被调用过一次之后，这个对象不能被设置偏向锁。因为如果可以的化，那Mark Word中的identity hash code必然会被偏向线程id给覆盖，这就会造成同一个对象前后两次调用hashCode()方法得到的结果不一致。</li>
<li>==升级为轻量级锁时==，JVM会在当前线程的栈顺中创律一个锁记录Lock Record)空间，用于存储锁对象的Mark Word拷贝，该据贝中可以包含identity hash code，所以轻量级锁可以和identity hash code共存，哈希码和GC年龄自然保存在此，释放锁后会将这些信息写回到对象头。</li>
<li>==升级为重量级锁后==，Mark Word保存的重量级锁指针，代表重量级锁的bjectMonitor类里有字段记录非加锁状态下的Mark Word，锁释放后也会将信息写回到对象头。</li>
</ul>
<h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><p>既然说到了排队等候机制，那么就一定会有某种队列形成，这样的队列是什么数据结构呢?<br>如果共享资源被占用，就需要一定的阻塞等待唤醒机制来保证锁分配。这个机制主要用的是CLH队列的变体实现的，将暂时获取不到锁的线程加入到队列中，这个队列就是AQS同步队列的抽象表现。它将要请求共享资源的线程及自身的等待状态封装成队列的结点对象(Node)，通过<br>CAS、自旋以及LockSupport.park0)的方式，维护tate变量的状态，使并发达到同步的效果。</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><h5 id="AQS使用一个volatie的int类型的成员变量来表示同步状态，通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配，通过CAS完成对State值的修改"><a href="#AQS使用一个volatie的int类型的成员变量来表示同步状态，通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配，通过CAS完成对State值的修改" class="headerlink" title="AQS使用一个volatie的int类型的成员变量来表示同步状态，通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配，通过CAS完成对State值的修改"></a>AQS使用一个volatie的int类型的成员变量来表示同步状态，通过内置的FIFO队列来完成资源获取的排队工作将每条要去抢占资源的线程封装成一个Node节点来实现锁的分配，通过CAS完成对State值的修改</h5><p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/%E7%B1%BB%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt="类的关系"></p>
<p><img src="https://v1.mykkto.cn/image/blog/2023/specialcolumn/yjc/reentranLock%E6%BA%90%E7%A0%81%E4%B9%8BAQS.png"></p>
<p>AQS(AbstractQueuedSynchronizer)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> 
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span><span class="token comment">//非公平</span>
         <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span>   <span class="token comment">//公平</span>
             
         <span class="token comment">//以非公平为例子跟踪</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//自旋修改状态</span>
                     <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把当前锁的持有则</span>
            <span class="token keyword">else</span>
                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>第一部分<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
	<span class="token comment">/**
	 1尝试加锁 2加锁失败线程入队3线程入队后，线程进入阻塞
	*/</span>
	 <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token comment">//具体的子类实现NonfairSync</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
<span class="token comment">/**
*情况一 查看当前状态是否等于0，如果是就进入自旋尝试修改状态，并把当前线程 设置锁的拥有者。返回true,
当前线程的是否和锁的持有者一同一线程，是就更改锁的状态，
*/</span>
     <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span> <span class="token comment">//更新锁的状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>第二部分<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token comment">//加入对象等</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Try the fast path of enq; backup to full enq on failure</span>
        <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//不是第一创建队列，后续的节点进来直接就添加的双端队列的末尾</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//入队，队列初始化</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//  第一进入队列的</span>
 <span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Must initialize</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//创建一个新的节点首尾相连  //自旋</span>
                    tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// //自旋</span>
                    t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>  <span class="token comment">//把刚进来的节点加入到队列</span>
                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//尝试获得锁，没有获得就阻塞等待唤醒</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//等待唤醒之前修改节点的等待状态</span>
 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>
           
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">//线程阻塞 中断机制</span>
 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//阻塞</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//中断标志获得锁的线程标志，协商。需要获得锁自行决定是否是否</span>
    <span class="token punctuation">}</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>第三部分<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    <span class="token comment">/***
    取消等待
    
    */</span> 
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Ignore if node doesn't exist</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        
        <span class="token class-name">Node</span> pred <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span> <span class="token comment">//移除节点</span>

        <span class="token class-name">Node</span> predNext <span class="token operator">=</span> pred<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

        node<span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>CANCELLED<span class="token punctuation">;</span>

     
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> tail <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//尝试修改当前的的尾部</span>
            <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       
            <span class="token keyword">int</span> ws<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> head <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL <span class="token operator">||</span>
                 <span class="token punctuation">(</span>ws <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//修改 前面节点唤醒状态</span>
                pred<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Node</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获得释放锁并改变status 的状态</span>
            <span class="token punctuation">}</span>

            node<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// help GC</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CAS 修改值</span>

       
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    s <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="AQS定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore-CountDownLatch）"><a href="#AQS定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore-CountDownLatch）" class="headerlink" title="AQS定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore/CountDownLatch）"></a>AQS定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如ReentrantLock）和Share（共享，多个线程可同时执行，如Semaphore/CountDownLatch）</h4><h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><h5 id="transient-volatile-Node-head"><a href="#transient-volatile-Node-head" class="headerlink" title="transient volatile Node head"></a>transient volatile Node head</h5><h6 id="waiter队列的头，刚开始时是一个啥都没有的结点，后面解锁一个去掉一个"><a href="#waiter队列的头，刚开始时是一个啥都没有的结点，后面解锁一个去掉一个" class="headerlink" title="waiter队列的头，刚开始时是一个啥都没有的结点，后面解锁一个去掉一个"></a>waiter队列的头，刚开始时是一个啥都没有的结点，后面解锁一个去掉一个</h6><h5 id="transient-volatile-Node-tail"><a href="#transient-volatile-Node-tail" class="headerlink" title="transient volatile Node tail"></a>transient volatile Node tail</h5><h6 id="waiter队列的尾，第一次上锁没锁上的往后边插，每当一个倒霉蛋没有获得锁，就加入队列"><a href="#waiter队列的尾，第一次上锁没锁上的往后边插，每当一个倒霉蛋没有获得锁，就加入队列" class="headerlink" title="waiter队列的尾，第一次上锁没锁上的往后边插，每当一个倒霉蛋没有获得锁，就加入队列"></a>waiter队列的尾，第一次上锁没锁上的往后边插，每当一个倒霉蛋没有获得锁，就加入队列</h6><h5 id="volatile-int-state"><a href="#volatile-int-state" class="headerlink" title="volatile int state"></a>volatile int state</h5><h6 id="不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可"><a href="#不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可" class="headerlink" title="不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可"></a>不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源state的获取与释放方式即可</h6><h4 id="方法-未具体实现，只抛异常"><a href="#方法-未具体实现，只抛异常" class="headerlink" title="方法(未具体实现，只抛异常)"></a>方法(未具体实现，只抛异常)</h4><h5 id="tryAcquire-int-：独占方式。尝试获取资源，成功则返回true，失败则返回false"><a href="#tryAcquire-int-：独占方式。尝试获取资源，成功则返回true，失败则返回false" class="headerlink" title="tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false"></a>tryAcquire(int)：独占方式。尝试获取资源，成功则返回true，失败则返回false</h5><h5 id="tryRelease-int-：独占方式。尝试释放资源，成功则返回true，失败则返回false"><a href="#tryRelease-int-：独占方式。尝试释放资源，成功则返回true，失败则返回false" class="headerlink" title="tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false"></a>tryRelease(int)：独占方式。尝试释放资源，成功则返回true，失败则返回false</h5><h5 id="tryAcquireShared-int-：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源"><a href="#tryAcquireShared-int-：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源" class="headerlink" title="tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源"></a>tryAcquireShared(int)：共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源</h5><h5 id="tryReleaseShared-int-：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false"><a href="#tryReleaseShared-int-：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false" class="headerlink" title="tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false"></a>tryReleaseShared(int)：共享方式。尝试释放资源，如果释放后允许唤醒后续等待结点返回true，否则返回false</h5><h4 id="方法（已实现）"><a href="#方法（已实现）" class="headerlink" title="方法（已实现）"></a>方法（已实现）</h4><h5 id="acquire-int"><a href="#acquire-int" class="headerlink" title="acquire(int)"></a>acquire(int)</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="tryAcquire-尝试直接去获取资源，如果成功则直接返回（这里体现了非公平锁，每个线程获取锁时会尝试直接抢占加塞一次，而CLH队列中可能还有别的线程在等待）；"><a href="#tryAcquire-尝试直接去获取资源，如果成功则直接返回（这里体现了非公平锁，每个线程获取锁时会尝试直接抢占加塞一次，而CLH队列中可能还有别的线程在等待）；" class="headerlink" title="tryAcquire()尝试直接去获取资源，如果成功则直接返回（这里体现了非公平锁，每个线程获取锁时会尝试直接抢占加塞一次，而CLH队列中可能还有别的线程在等待）；"></a>tryAcquire()尝试直接去获取资源，如果成功则直接返回（这里体现了非公平锁，每个线程获取锁时会尝试直接抢占加塞一次，而CLH队列中可能还有别的线程在等待）；</h5><h5 id="addWaiter-将该线程加入等待队列的尾部，并标记为独占模式；"><a href="#addWaiter-将该线程加入等待队列的尾部，并标记为独占模式；" class="headerlink" title="addWaiter()将该线程加入等待队列的尾部，并标记为独占模式；"></a>addWaiter()将该线程加入等待队列的尾部，并标记为独占模式；</h5><h5 id="acquireQueued-使线程阻塞在等待队列中获取资源，一直获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。-自旋"><a href="#acquireQueued-使线程阻塞在等待队列中获取资源，一直获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。-自旋" class="headerlink" title="acquireQueued()使线程阻塞在等待队列中获取资源，一直获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。(自旋)"></a>acquireQueued()使线程阻塞在等待队列中获取资源，一直获取到资源后才返回。如果在整个等待过程中被中断过，则返回true，否则返回false。(自旋)</h5><h5 id="如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt-，将中断补上。"><a href="#如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt-，将中断补上。" class="headerlink" title="如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt()，将中断补上。"></a>如果线程在等待过程中被中断过，它是不响应的。只是获取资源后才再进行自我中断selfInterrupt()，将中断补上。</h5><h5 id="release-int"><a href="#release-int" class="headerlink" title="release(int)"></a>release(int)</h5><h6 id="tryRelease-int-，tryRelease-都会成功的，因为这是独占模式，该线程来释放资源，那么它肯定已经拿到独占资源了，直接减掉相应量的资源即可-state-arg-，也不需要考虑线程安全的问题。release是根据tryRelease-的返回值来判断线程是否已经完成资源释放。所以实现时，-state-0-，要返回true，否则返回false。"><a href="#tryRelease-int-，tryRelease-都会成功的，因为这是独占模式，该线程来释放资源，那么它肯定已经拿到独占资源了，直接减掉相应量的资源即可-state-arg-，也不需要考虑线程安全的问题。release是根据tryRelease-的返回值来判断线程是否已经完成资源释放。所以实现时，-state-0-，要返回true，否则返回false。" class="headerlink" title="tryRelease(int)，tryRelease()都会成功的，因为这是独占模式，该线程来释放资源，那么它肯定已经拿到独占资源了，直接减掉相应量的资源即可(state-=arg)，也不需要考虑线程安全的问题。release是根据tryRelease()的返回值来判断线程是否已经完成资源释放。所以实现时，(state=0)，要返回true，否则返回false。"></a>tryRelease(int)，tryRelease()都会成功的，因为这是独占模式，该线程来释放资源，那么它肯定已经拿到独占资源了，直接减掉相应量的资源即可(state-=arg)，也不需要考虑线程安全的问题。release是根据tryRelease()的返回值来判断线程是否已经完成资源释放。所以实现时，(state=0)，要返回true，否则返回false。</h6><h6 id="unparkSuccessor-Node-用LockSupport-unpark-方法唤醒队列中最欠扁的那个未放弃的线程。一般来说当前结点的后一个结点就是下一个，但是也可能后面的结点放弃了，这时从尾巴一直往前找，找到第一个能跑的就让他跑"><a href="#unparkSuccessor-Node-用LockSupport-unpark-方法唤醒队列中最欠扁的那个未放弃的线程。一般来说当前结点的后一个结点就是下一个，但是也可能后面的结点放弃了，这时从尾巴一直往前找，找到第一个能跑的就让他跑" class="headerlink" title="unparkSuccessor(Node)  用LockSupport.unpark()方法唤醒队列中最欠扁的那个未放弃的线程。一般来说当前结点的后一个结点就是下一个，但是也可能后面的结点放弃了，这时从尾巴一直往前找，找到第一个能跑的就让他跑"></a>unparkSuccessor(Node)  用LockSupport.unpark()方法唤醒队列中最欠扁的那个未放弃的线程。一般来说当前结点的后一个结点就是下一个，但是也可能后面的结点放弃了，这时从尾巴一直往前找，找到第一个能跑的就让他跑</h6><h4 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h4><h5 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h5><h5 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h5><h6 id="volatile-Node-prev-前驱"><a href="#volatile-Node-prev-前驱" class="headerlink" title="volatile Node prev 前驱"></a>volatile Node prev 前驱</h6><h6 id="volatile-Node-next-后继"><a href="#volatile-Node-next-后继" class="headerlink" title="volatile Node next 后继"></a>volatile Node next 后继</h6><h6 id="volatile-int-waitStatus"><a href="#volatile-int-waitStatus" class="headerlink" title="volatile int waitStatus"></a>volatile int waitStatus</h6><ul>
<li>CANCELLED = 1：表示当前结点已取消调度。当timeout或被中断（响应中断的情况下），会触发变更为此状态，进入该状态后的结点将不会再变化。</li>
<li>默认值0 新节点入队时默认状态</li>
<li>SIGNAL  = -1后继结点在等待当前结点唤醒，后记结点入队时，会将前驱结点更新未SIGNAL</li>
<li>CONDITION = -2表示结点等待在Condition上，当其他线程调用了Condition的signal()方法后CONDITION状态的结点将从等待队列转移到同步队列中，等待获取同步锁</li>
<li>PROPAGATE = -3共享模式下，前继结点不仅会唤醒其后继结点，同时也可能会唤醒后继的后继结点。</li>
</ul>
<h6 id="Node-nextWaiter"><a href="#Node-nextWaiter" class="headerlink" title="Node nextWaiter"></a>Node nextWaiter</h6><h6 id="volatile-Thread-thread"><a href="#volatile-Thread-thread" class="headerlink" title="volatile Thread thread"></a>volatile Thread thread</h6><p>+抢锁的线程</p>
<h5 id="ConditionObject"><a href="#ConditionObject" class="headerlink" title="ConditionObject"></a>ConditionObject</h5><h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><h4 id="线程池用过吗？ThreadPoolExecutor谈谈你的理解"><a href="#线程池用过吗？ThreadPoolExecutor谈谈你的理解" class="headerlink" title="==线程池用过吗？ThreadPoolExecutor谈谈你的理解=="></a>==线程池用过吗？ThreadPoolExecutor谈谈你的理解==</h4><h5 id="线程-优势"><a href="#线程-优势" class="headerlink" title="线程==优势=="></a>线程==优势==</h5><ul>
<li>线程池做的工作主要是控制运行的线程的数量.处理过程中将任务放入队列.然后在线程创建后启动这些任务如果线程数量超过了最大数量超出数量的线程排队等候,等其它线程执行完毕,再从队列中取出任务来执行。</li>
<li>它的主要特点为:线程复用;控制最大并发数:;管理线程</li>
<li>第一:降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗</li>
<li>第二:提高响应速度。当任务到达时,任务可以不需要的等到线程创建就能立即执行</li>
<li>第三:提高线程的可管理性。线程是稀缺资源如果无限制的创建,不仅会消耗系统资源还会降低系统的稳定性使用线程池可以进行统一的分配调优和监控</li>
</ul>
<h4 id="线程池如何使用"><a href="#线程池如何使用" class="headerlink" title="线程池如何使用"></a>线程池如何使用</h4><h5 id="Executors-newScheduledThreadPool"><a href="#Executors-newScheduledThreadPool" class="headerlink" title="Executors.newScheduledThreadPool()"></a>Executors.newScheduledThreadPool()</h5><h5 id="JDK1-8-Executors-newScheduledThreadPool-int"><a href="#JDK1-8-Executors-newScheduledThreadPool-int" class="headerlink" title="JDK1.8  Executors.newScheduledThreadPool(int)"></a>JDK1.8  Executors.newScheduledThreadPool(int)</h5><h5 id="Executors-newFixedThreadPool-integer"><a href="#Executors-newFixedThreadPool-integer" class="headerlink" title="Executors.newFixedThreadPool(integer);"></a>Executors.newFixedThreadPool(integer);</h5><ul>
<li><p>场景：执行长期的任务，性能好很多</p>
</li>
<li><p>主要的特点：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads，nThreads<span class="token punctuation">,</span>keepAliveTime<span class="token operator">:</span><span class="token number">0L</span>，<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token class-name">MILLISECONDSnew</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                               <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



</li>
</ul>
<ul>
<li>创建一个定长线程池可控制线程最大并发数超出的线程会在队列中等待。</li>
<li>newFixedThreadPool创建的线程池 corePoolsize和 maximumPoolsize值是相等的它使用的 LinkedBlockingQueue</li>
</ul>
<h5 id="xecutors-newSingleThreadExecutor"><a href="#xecutors-newSingleThreadExecutor" class="headerlink" title="xecutors.newSingleThreadExecutor();"></a>xecutors.newSingleThreadExecutor();</h5><ul>
<li><p>一个任务一个任务执行的场景</p>
</li>
<li><p>主要的特点：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span> corePoolSize<span class="token operator">:</span> <span class="token number">1</span>，maxmumPoolSize<span class="token operator">:</span> <span class="token number">1</span>keepAliveTime<span class="token operator">:</span> <span class="token number">0L</span>TimeUnit<span class="token punctuation">.</span><span class="token class-name">MILLISECONDSnew</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>创建一个单线程化的线程池,它只会用唯一的工作线程来执行任务,保证所有任务按照指定顺序执行。</li>
<li>newSingleThreadExecutor将 corePoolsize和 maximumPoolsize都设置为1它使用的LinkedBlockingQueue</li>
</ul>
</li>
</ul>
<h5 id="Executors-newCachedThreadPool"><a href="#Executors-newCachedThreadPool" class="headerlink" title="Executors.newCachedThreadPool()"></a>Executors.newCachedThreadPool()</h5><ul>
<li><p>适用：执行很多短期异步的小程序或者负载比较轻的服务器</p>
</li>
<li><p>主要的特点：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span> corePoolSize<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token class-name">MAX</span> VALUE<span class="token punctuation">,</span>keepAliveTime<span class="token operator">:</span> <span class="token number">60L</span>，<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token class-name">SECONDSnew</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>创建一个可缓存线程池,如果线程池长度超过处理需要,可灵活回收空闲线程,若无可回收,则新建线程。</p>
</li>
<li><p> newCachedThreadPool将 corePoolsize设置为0,将 maximumPoolsize设置为Integer.MAXVALUE使用的synchronousQueue,也就是说来了任务就创建线程运行当线程空闲超过60秒就销毁线程</p>
</li>
</ul>
</li>
</ul>
<h4 id="线程池的几个重要参数介绍？"><a href="#线程池的几个重要参数介绍？" class="headerlink" title="==线程池的几个重要参数介绍？=="></a>==线程池的几个重要参数介绍？==</h4><h5 id="7大参数"><a href="#7大参数" class="headerlink" title="7大参数"></a>7大参数</h5><h6 id="int-corePoolSize"><a href="#int-corePoolSize" class="headerlink" title="int corePoolSize"></a>int corePoolSize</h6><ul>
<li>线程池中的常驻核心线程数</li>
</ul>
<h6 id="int-maximumPoolSize"><a href="#int-maximumPoolSize" class="headerlink" title="int maximumPoolSize"></a>int maximumPoolSize</h6><ul>
<li>线程池能够容纳同时执行的最大线程数,此值必须大于等于1</li>
</ul>
<h6 id="long-keepAliveTime"><a href="#long-keepAliveTime" class="headerlink" title="long keepAliveTime"></a>long keepAliveTime</h6><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">在创建了线程池后,当有请求任务来之后,就会安排池中的线程去执行请求任务,近似理解为今日当值线程,当线程池中的线程数目达到 core PoolSize后就会把到达的任务放到缓有队列中<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>多余的空闲线程的存活时间。线程池数量超过 core poolsize时,当空闲时间达到 keepAliveTime值时</li>
<li>多余空闲线程会被销毁直到只剩下 core Poolsize个线程为止</li>
</ul>
<h6 id="TimeUnit-unit"><a href="#TimeUnit-unit" class="headerlink" title="TimeUnit unit"></a>TimeUnit unit</h6><ul>
<li>keepAliveTime的单位</li>
</ul>
<h6 id="BlockingQueue-workQueue"><a href="#BlockingQueue-workQueue" class="headerlink" title="BlockingQueue workQueue"></a>BlockingQueue<runnable> workQueue</runnable></h6><ul>
<li>任务队列,被提交但尚未被执行的任务。</li>
</ul>
<h6 id="ThreadFactory-threadFactory"><a href="#ThreadFactory-threadFactory" class="headerlink" title="ThreadFactory threadFactory"></a>ThreadFactory threadFactory</h6><ul>
<li>生成线程池中工作线程的线程工厂,用于创建线程<strong>一般用默认的即可</strong></li>
</ul>
<h6 id="RejectedExecutionHandler-handler"><a href="#RejectedExecutionHandler-handler" class="headerlink" title="RejectedExecutionHandler handler"></a>RejectedExecutionHandler handler</h6><ul>
<li>拒绝策略,表示当队列满了并且工作线程大于等于线程池的最大线程数(maximumpoolsize)时拒绝请求执行的策略</li>
</ul>
<h4 id="考点线程池底层原理"><a href="#考点线程池底层原理" class="headerlink" title="==考点线程池底层原理=="></a>==考点线程池底层原理==</h4><ul>
<li><p>在创建了线程池后等待提交过来的任务请求</p>
</li>
<li><p>2当调用execute(方法添加一个请求任务时线程池会做如下判断</p>
</li>
<li><p>2.1如果正在运行的线程数量小于corePoolsize,那么马上创建线程运行这个任务</p>
</li>
<li><p>2.2如果正在运行的线程数量大于或等于corePoolsize那么将这个任务放入队列</p>
</li>
<li><p>2.3如果这时候队列满了且正在运行的线程数量还小于 maximumPoolsize那么还是要创建非核心线程立刻运行这个任务,</p>
</li>
<li><p>2.4如果队列满了且正在运行的线程数量大于或等于maximumPoolsize那么线程池会启动饱和拒绝策略来执行。</p>
</li>
<li><p>3当一个线程完成任务时,它会从队列中取下一个任务来执行</p>
</li>
<li><p>4当一个线程无事可做超过一定的时间( keepAliveTime)时线程池会==判断==</p>
<ul>
<li>如果当前运行的线程数大于corePoolsize那么这个线程就被停掉所以线程池的所有任务完成后它最终会收缩到corePoolsize的大小</li>
</ul>
</li>
</ul>
<h4 id="生产上你如何设置合理参数？"><a href="#生产上你如何设置合理参数？" class="headerlink" title="==生产上你如何设置合理参数？=="></a>==生产上你如何设置合理参数？==</h4><h5 id="线程池的拒绝策略你谈谈"><a href="#线程池的拒绝策略你谈谈" class="headerlink" title="线程池的拒绝策略你谈谈"></a>线程池的拒绝策略你谈谈</h5><h6 id="什么是拒绝策略"><a href="#什么是拒绝策略" class="headerlink" title="什么是拒绝策略"></a>什么是拒绝策略</h6><ul>
<li>等待队列也已经排满了,再也塞不下新任务了同时，线程池中的max线程也达到了,无法继续为新任务服务</li>
<li>这时候我们就需要==拒绝策略机制合理==的处理这个问题</li>
</ul>
<h6 id="JDK内置的拒绝策略"><a href="#JDK内置的拒绝策略" class="headerlink" title="JDK内置的拒绝策略"></a>JDK内置的拒绝策略</h6><ul>
<li><p>AbortPolicyl(默认):直接抛出 Rejected Execution Exception异常阻止系统正常运行。</p>
</li>
<li><p>CallerRunsPolicy:”调用者运行”一种调节机制,该策略傚不会抛弃任务,也不会抛出异常,而是将某些任务回退到调用者，从而降低新任务的流量</p>
</li>
<li><p>Discardoldest polic:抛弃队列中等待最久的任务,然后把当前任务加入队中尝试再次提交当前仼务。</p>
</li>
<li><p>DiscardPolicy:直接丢弃任务,不予任何处理也不抛出异常。如果允许任务丢失,这是最好的一种方案。</p>
</li>
<li><p>以上内置拒绝策略均实现了RejectedExecutionHandler接口</p>
</li>
</ul>
<h5 id="考点：你在工作中单一的-固定数的可变的三种创建线程池的方法-你用那个多"><a href="#考点：你在工作中单一的-固定数的可变的三种创建线程池的方法-你用那个多" class="headerlink" title="==考点：你在工作中单一的/固定数的可变的三种创建线程池的方法,你用那个多?=="></a>==考点：你在工作中单一的/固定数的可变的三种创建线程池的方法,你用那个多?==</h5><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">一个都不用，我们生产上只能使用自定义的
Executors中JDK已经给你提供了，为什么不用?
来自阿里巴巴开发规范手册
[强制]**线程池不允许使用Executors 去创建，而是通过ThreadPoolExecutor 的方式，这样规避资源耗尽的风险。的处理方式让写的同学更加明确线程池的运行规则，*说明:Executors 返回的线程池对象的弊端如下:1)FixedThreadPool和 SingleThreadPool允许的请求队列长度为lntegerMAXVALUE，可能会堆积大量的请求，从而导致00M。2)CachedThreadPool 和 ScheduledThreadPoo1:允许的创建线程数量为Integer.MAXVALUE，可能会创建大量的线程，从而导致 OOM。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="在工作中是如何使用线程池的-是否自定义过线程池使用"><a href="#在工作中是如何使用线程池的-是否自定义过线程池使用" class="headerlink" title="==在工作中是如何使用线程池的,是否自定义过线程池使用=="></a>==在工作中是如何使用线程池的,是否自定义过线程池使用==</h5><ul>
<li>按照Executors中的照猫画虎就好了，就是最大线程数不要用Integer.MaxValue</li>
</ul>
<h5 id="合理配置线程池你是如何考虑的"><a href="#合理配置线程池你是如何考虑的" class="headerlink" title="==合理配置线程池你是如何考虑的?=="></a>==合理配置线程池你是如何考虑的?==</h5><ul>
<li><p>CPU密集型</p>
<ul>
<li><pre><code class="txt">CPU密集的意思是该任务需要大量的运算而没有阻塞CPU一直全速运行
CPU密集任务只有在真正的多核CPU上才可能得到加速(通过多线程)，而在单核CPU上(悲剧吧? = =!)无论你开几个模拟的多线程该任务都不可能得到加速因为CPU总的运算能力就那些。
CPU密集型任务配置尽可能少的线程数量一般公式:CPU核数+1个线程的线程池</code></pre>
</li>
</ul>
</li>
</ul>
<ul>
<li>IO密集型（1O蜜集型即该任务需要大量的IO 即大量的阻塞。）<ul>
<li>由于10密集型任务线程并不是一直在执行任务则应配置尽可能多的线程如cPU核数”2</li>
<li>在单线程上运行IO密集型的任务会导致浪费大量的CPU运算能力浪费在等待所以在I0密集型任务中使用多线程可以大大的加速程序运行即使在单核CPU上这种加速主要就是利用了被浪费掉的阻塞时间</li>
<li>IO密集型时,大部分线程都阻塞故需要多配置线程数参考公式:CPU核数/1-阳塞系数<br>阻塞系数在0.8~09之间<br>比如8核CPU:8/(1-09)=80个线程数</li>
</ul>
</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">杨江长</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://mykkto.github.io/posts/ee9ed7cb.html">https://mykkto.github.io/posts/ee9ed7cb.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">杨江长</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/juc/">
                                    <span class="chip bg-color">juc</span>
                                </a>
                            
                                <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/">
                                    <span class="chip bg-color">面试题</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">请 jack喝瓶水吧~</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    .v[data-class="v"] .vwrap .vheader .vinput {
      width: 32%;
      border-bottom: 1px dashed #dedede;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
let metaPlaceholder = {"nick":"昵称/QQ号(必填)","mail":"邮箱(必填)","link":"网址(https://)"} ;
//这里要换行
new Valine({
        el: '#vcomments',
        appId: 'qjrJlrw1qmt7F5B7chl9x2cg-gzGzoHsz',
        appKey: 'Bt14wYdLiL8jYRqxFbpOjBkK',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-CN',
        placeholder: '留下你的足迹..',
        meta: ["nick", "mail", "link"],
        recordIP: 'true' === 'true',
        enableQQ: 'monsterid',
        requiredFields: ["46606772953bed0812789d6dc955614e"],
        master: ["46606772953bed0812789d6dc955614e"],
        friends: ["cb3e577ff029d6073400d5557effd41f", ""],
        tagMeta: ["博主", "小伙伴", "访客"],
        metaPlaceholder: metaPlaceholder,

    });

    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('vsubmit')) {
            const email = document.querySelector('input[type=email]');
            const nick = document.querySelector('input[name=nick]');
            const reg = /^[A-Za-z0-9_-\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
            if (!email.value || !nick.value || !reg.test(email.value)) {
                const str = `<div class="valert txt-center"><div class="vtext">请填写正确的昵称和邮箱！</div></div>`;
                const vmark = document.querySelector('.vmark');
                vmark.innerHTML = str;
                vmark.style.display = 'block';

                e.stopPropagation();

                setTimeout(function() {
                    vmark.style.display = 'none';
                    vmark.innerHTML = '';
                }, 2500);
            }
        }
        }, true);
</script>



    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/45f5cab5.html">
                    <div class="card-image">
                        
                        
                        <img src="https://v1.mykkto.cn/image/galleries/动漫风景/05.jpg" class="responsive-img" alt="面试题-03(关于Cloud)">
                        
                        <span class="card-title">面试题-03(关于Cloud)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            这是一篇关于SpringCloud技术栈的合集面试题，也不仅仅是cloud.
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-02-15 22:28:51
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/" class="post-category">
                                    面试题
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/springcloud/">
                        <span class="chip bg-color">springcloud</span>
                    </a>
                    
                    <a href="/tags/%E9%9D%A2%E8%AF%95/">
                        <span class="chip bg-color">面试</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/f83c265d.html">
                    <div class="card-image">
                        
                        
                        <img src="https://v1.mykkto.cn/image/galleries/动漫风景/08.jpg" class="responsive-img" alt="灰度发布方案">
                        
                        <span class="card-title">灰度发布方案</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            本篇会有，主要介绍gateway做灰度发布的简单案例落地，以及性能较高的Nginx
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-11-27 13:22:33
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8A%80%E6%9C%AF%E6%A0%88/" class="post-category">
                                    分布式技术栈
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/gateway/">
                        <span class="chip bg-color">gateway</span>
                    </a>
                    
                    <a href="/tags/%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/">
                        <span class="chip bg-color">灰度发布</span>
                    </a>
                    
                    <a href="/tags/nginx/">
                        <span class="chip bg-color">nginx</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('520')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: jack<br />'
            + '文章作者: jack<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="tencent"
                   type="playlist"
                   id="3077201383"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">jack</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">215.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2022";
                    var startMonth = "1";
                    var startDate = "7";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
            <span id="icp"><img src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="https://beian.miit.gov.cn" target="_blank">闽ICP备2022004353号-1</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/mykkTo" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:763856958@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=763856958" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 763856958" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="763856958" class="tooltipped" target="_blank" data-tooltip="关注我的微博: 763856958" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.11/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?aaa6c944b0ed07922901d7fc571a171d";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

<!-- 深色模式按钮 -->
    <script>
        if (localStorage.getItem('dark') === '1') {
        document.body.classList.add('dark');
        }
        else if (new Date().getHours() >= 22 || new Date().getHours() < 7) {
        document.body.classList.add('dark');
        } 
        else if (matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
        }
    </script>
    <a onclick="switchNightMode()" id="sma">
        <i class="fas fa-lightbulb" id="nightMode" aria-hidden="true"></i>
    </a>

    <!-- 天气接口控件   -->
    
        <script type="text/javascript">
        WIDGET = {FID: 'zLkJSQpqsh'}
        </script>
    <!-- <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script> -->

    <script type="text/javascript">
      var windowWidth = $(window).width();
      if (windowWidth > 768) {
          document.write('<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"><\/script>');
      }
    </script>
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: "b998e00e",
        });
        daovoice('update');
    </script>
    

	
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
